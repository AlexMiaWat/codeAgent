# Тестирование HTTP API сервера

## Быстрый старт

### 1. Проверка доступности сервера

Перед запуском тестов API убедитесь, что сервер запущен:

```bash
# Проверка сервера
python test/check_server.py
```

Если сервер не запущен, вы увидите:
```
[FAIL] Сервер недоступен на http://127.0.0.1:3456

Для запуска сервера:
  1. Откройте отдельную консоль
  2. Выполните: python main.py
  3. Дождитесь сообщения о запуске сервера
```

### 2. Запуск сервера

В отдельной консоли:
```bash
python main.py
```

Дождитесь сообщения о запуске сервера (обычно это занимает несколько секунд).

### 3. Запуск тестов API

После запуска сервера:
```bash
# Через единый скрипт
python test/run_tests.py --api

# Или через Makefile
make test-api
```

## Что тестируется

### test_server_api_only.py
- `GET /health` - Health check endpoint
- `GET /` - Root endpoint (главная страница)
- `GET /status` - Status endpoint (статус сервера и задач)

### test_real_server_integration.py
- Интеграционное тестирование сервера
- Автоматический запуск сервера (если не запущен)
- Тестирование всех API endpoints

## Устранение проблем

### Ошибка: "Сервер недоступен"

**Причина:** Сервер не запущен или не отвечает на порту 3456.

**Решение:**
1. Проверьте, запущен ли сервер:
   ```bash
   python test/check_server.py
   ```

2. Если сервер не запущен, запустите его:
   ```bash
   python main.py
   ```

3. Убедитесь, что порт 3456 свободен:
   ```bash
   # Windows
   netstat -ano | findstr :3456
   
   # Linux/Mac
   lsof -i :3456
   ```

### Ошибка: "Connection refused"

**Причина:** Сервер не запущен или порт занят другим процессом.

**Решение:**
1. Остановите другие процессы на порту 3456
2. Перезапустите сервер: `python main.py`
3. Подождите несколько секунд для полного запуска

### Тесты проходят, но вывод на русском с кракозябрами

**Причина:** Проблемы с кодировкой в Windows консоли.

**Решение:** Скрипт автоматически устанавливает UTF-8 кодировку. Если проблема сохраняется, используйте:
```bash
chcp 65001
python test/run_tests.py --api
```

## Автоматическая проверка

Скрипт `run_tests.py` автоматически проверяет доступность сервера перед запуском API тестов:

- ✅ Если сервер запущен - тесты выполняются
- ⚠️ Если сервер не запущен - выводится предупреждение и инструкции

## Примеры использования

### Полная проверка API
```bash
# Терминал 1: Запуск сервера
python main.py

# Терминал 2: Запуск тестов
python test/run_tests.py --api
```

### Быстрая проверка (без вывода тестов)
```bash
python test/run_tests.py --api --no-output
```

### Минимальный вывод (только итоги)
```bash
python test/run_tests.py --api --quiet
```

### Комбинирование с другими тестами
```bash
# API + OpenRouter
python test/run_tests.py --api --openrouter
```

## Структура тестов

```
test/
├── run_tests.py              # Единая точка входа
├── check_server.py           # Утилита проверки сервера
├── test_server_api_only.py   # Простые тесты API (сервер должен быть запущен)
└── test_real_server_integration.py  # Интеграционные тесты (может запустить сервер)
```

## Дополнительная информация

- Все тесты используют базовый URL: `http://127.0.0.1:3456`
- Таймаут для каждого теста: 60-120 секунд
- Тесты не останавливают сервер (если он был запущен до тестов)
