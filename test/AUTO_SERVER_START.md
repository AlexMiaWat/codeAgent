# Автоматический запуск сервера в тестах

## Как это работает

Тест `test_real_server_integration.py` автоматически запускает сервер, если он не запущен.

### Логика работы:

1. **Проверка доступности сервера**
   - Тест проверяет `http://127.0.0.1:3456/health`
   - Если сервер отвечает → использует существующий сервер
   - Если сервер не отвечает → запускает новый сервер

2. **Автоматический запуск**
   - По умолчанию `start_server_flag=True`
   - Сервер запускается через `subprocess.Popen([python, main.py])`
   - Ожидание запуска до 30 секунд
   - После тестов сервер останавливается (если был запущен тестом)

3. **Режим без автозапуска**
   - Используйте флаг `--no-start` для отключения автозапуска
   - В этом случае сервер должен быть запущен вручную

## Использование

### Автоматический запуск (по умолчанию)

```bash
# Сервер запустится автоматически, если не запущен
python test/test_real_server_integration.py

# Через единый скрипт (тоже автоматический запуск)
python test/run_tests.py --api
```

### Без автозапуска (сервер должен быть запущен)

```bash
# Сервер должен быть запущен вручную
python test/test_real_server_integration.py --no-start
```

## Отладка

### Проверка, запущен ли сервер

```bash
python test/check_server.py
```

### Проверка логов запуска

Тест выводит отладочную информацию:
- `[DEBUG] start_server_flag = True/False` - режим автозапуска
- `[INFO] Сервер уже запущен` - сервер найден
- `[INFO] Запускаем сервер автоматически...` - запуск нового сервера
- `[OK] Сервер успешно запущен автоматически` - успешный запуск

### Проблемы при автозапуске

Если сервер не запускается автоматически:

1. **Проверьте порт 3456**
   ```bash
   # Windows
   netstat -ano | findstr :3456
   
   # Linux/Mac
   lsof -i :3456
   ```

2. **Проверьте логи запуска**
   - Тест выводит ошибки в stderr
   - Проверьте вывод `[FAIL]` сообщений

3. **Запустите сервер вручную для диагностики**
   ```bash
   python main.py
   ```
   Посмотрите на ошибки при запуске

4. **Проверьте переменные окружения**
   - `PROJECT_DIR` должна быть установлена
   - Проверьте файл `.env`

## Примеры

### Пример 1: Сервер не запущен

```
[DEBUG] start_server_flag = True
[DEBUG] Проверка доступности сервера на http://127.0.0.1:3456...
[DEBUG] ConnectionError: ...
[INFO] Сервер не запущен (ConnectionError)
[INFO] Запускаем сервер автоматически...
[INFO] Проект: D:\Space\life
[INFO] Запуск сервера...
[INFO] Ожидание запуска сервера (макс. 30 сек)...
[OK] Сервер запущен успешно (PID: 12345)
[OK] Сервер успешно запущен автоматически
```

### Пример 2: Сервер уже запущен

```
[DEBUG] start_server_flag = True
[DEBUG] Проверка доступности сервера на http://127.0.0.1:3456...
[INFO] Сервер уже запущен, используем существующий
[DEBUG] Сервер отвечает на /health: {'status': 'healthy', ...}
```

### Пример 3: Автозапуск отключен

```
[INFO] Режим автоматического запуска сервера отключен (--no-start)
[INFO] Сервер должен быть запущен вручную
[DEBUG] start_server_flag = False
[DEBUG] Проверка доступности сервера на http://127.0.0.1:3456...
[FAIL] Сервер не запущен и start_server_flag=False
[INFO] Запустите сервер вручную: python main.py
```

## Важные замечания

1. **Сервер не останавливается автоматически**, если был запущен до тестов
2. **Сервер останавливается автоматически**, если был запущен тестом
3. **Порт 3456** должен быть свободен для автозапуска
4. **Таймаут запуска** - 30 секунд (можно изменить в коде)

## Настройка

Для изменения таймаута запуска сервера измените параметр в `test_real_server_integration.py`:

```python
def start_server(self, timeout: int = 30) -> bool:  # Измените 30 на нужное значение
```
