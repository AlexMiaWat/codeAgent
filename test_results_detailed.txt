============================= test session starts ==============================
platform linux -- Python 3.10.12, pytest-9.0.2, pluggy-1.6.0
rootdir: /workspace
configfile: pytest.ini (WARNING: ignoring pytest config in pyproject.toml!)
plugins: cov-7.0.0, mock-3.15.1, asyncio-1.3.0, anyio-4.12.1
asyncio: mode=strict, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 73 items

src/test/test_context_analyzer_static.py .FF...................F......F. [ 42%]
.                                                                        [ 43%]
src/test/test_learning_tool_static.py .F.................F..F.           [ 76%]
src/test/test_smart_agent_static.py ..F.F......FF.F..                    [100%]

=================================== FAILURES ===================================
_________ TestContextAnalyzerToolStatic.test_supported_extensions_list _________

self = <src.test.test_context_analyzer_static.TestContextAnalyzerToolStatic object at 0x723d3165b310>

    def test_supported_extensions_list(self):
        """Проверка списка поддерживаемых расширений"""
        from src.tools.context_analyzer_tool import ContextAnalyzerTool
    
        with tempfile.TemporaryDirectory() as tmp_dir:
            tool = ContextAnalyzerTool(project_dir=tmp_dir)
    
            expected_extensions = ['.md', '.txt', '.rst', '.py', '.js', '.ts', '.json', '.yaml', '.yml']
    
>           assert tool.supported_extensions == expected_extensions
E           AssertionError: assert ['.md', '.txt...', '.ts', ...] == ['.md', '.txt...', '.ts', ...]
E             
E             Left contains 5 more items, first extra item: '.java'
E             Use -v to get more diff

src/test/test_context_analyzer_static.py:47: AssertionError
______ TestContextAnalyzerToolStatic.test_context_analyzer_initialization ______

self = <src.test.test_context_analyzer_static.TestContextAnalyzerToolStatic object at 0x723d3165b610>

    def test_context_analyzer_initialization(self):
        """Проверка инициализации ContextAnalyzerTool"""
        from src.tools.context_analyzer_tool import ContextAnalyzerTool
        import inspect
    
        # Проверяем сигнатуру __init__
        init_sig = inspect.signature(ContextAnalyzerTool.__init__)
        expected_params = ['self', 'project_dir', 'docs_dir', 'max_file_size',
                          'supported_extensions', 'kwargs']
    
        actual_params = list(init_sig.parameters.keys())
>       assert actual_params == expected_params
E       AssertionError: assert ['self', 'pro...nguages', ...] == ['self', 'pro...ns', 'kwargs']
E         
E         At index 5 diff: 'supported_languages' != 'kwargs'
E         Left contains 2 more items, first extra item: 'max_dependency_depth'
E         Use -v to get more diff

src/test/test_context_analyzer_static.py:65: AssertionError
_____ TestContextAnalyzerToolFormats.test_normalize_unicode_text_function ______

self = <src.test.test_context_analyzer_static.TestContextAnalyzerToolFormats object at 0x723d316edcf0>

    def test_normalize_unicode_text_function(self):
        """Проверка функции normalize_unicode_text"""
        from src.tools.context_analyzer_tool import normalize_unicode_text
    
        # Тест с обычным текстом
        assert normalize_unicode_text("Hello World") == "hello world"
    
        # Тест с Unicode символами
        result = normalize_unicode_text("Тест naïve résumé")
        assert "тест" in result
        assert "naive" in result  # без диакритических знаков
        assert "resume" in result  # без диакритических знаков
    
        # Тест с пустой строкой
        assert normalize_unicode_text("") == ""
    
        # Тест с None
>       assert normalize_unicode_text(None) == ""
E       AssertionError: assert None == ''
E        +  where None = <function normalize_unicode_text at 0x723cfdb19120>(None)

src/test/test_context_analyzer_static.py:454: AssertionError
_ TestContextAnalyzerToolErrorHandling.test_context_analyzer_get_task_context_empty_query _

self = <src.test.test_context_analyzer_static.TestContextAnalyzerToolErrorHandling object at 0x723d3165bd90>

    def test_context_analyzer_get_task_context_empty_query(self):
        """Тест получения контекста задачи с пустым запросом"""
        from src.tools.context_analyzer_tool import ContextAnalyzerTool
    
        with tempfile.TemporaryDirectory() as tmp_dir:
            tool = ContextAnalyzerTool(project_dir=tmp_dir)
    
>           result = tool.get_task_context("")

src/test/test_context_analyzer_static.py:553: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = ContextAnalyzerTool(name='ContextAnalyzerTool', description='Tool Name: ContextAnalyzerTool\nTool Arguments: {\n  "pro...', '.c', '.h'], supported_languages=['python', 'javascript', 'typescript', 'java', 'cpp', 'c'], max_dependency_depth=5)
task_description = ''

    def get_task_context(self, task_description: str) -> str:
        """
        Получение контекстной информации для задачи
    
        Args:
            task_description: Описание задачи
    
        Returns:
            Контекстная информация
        """
        # Валидация входных параметров
        if not task_description or not isinstance(task_description, str):
>           raise ValueError("task_description must be a non-empty string")
E           ValueError: task_description must be a non-empty string

src/tools/context_analyzer_tool.py:565: ValueError
___________ TestLearningToolStatic.test_learning_tool_initialization ___________

self = <src.test.test_learning_tool_static.TestLearningToolStatic object at 0x723d316ec820>

    def test_learning_tool_initialization(self):
        """Проверка инициализации LearningTool"""
        from src.tools.learning_tool import LearningTool
        import inspect
    
        # Проверяем сигнатуру __init__
        init_sig = inspect.signature(LearningTool.__init__)
        expected_params = ['self', 'experience_dir', 'max_experience_tasks', 'kwargs']
    
        actual_params = list(init_sig.parameters.keys())
>       assert actual_params == expected_params
E       AssertionError: assert ['self', 'exp...seconds', ...] == ['self', 'exp...ks', 'kwargs']
E         
E         At index 3 diff: 'enable_indexing' != 'kwargs'
E         Left contains 3 more items, first extra item: 'cache_size'
E         Use -v to get more diff

src/test/test_learning_tool_static.py:51: AssertionError
_______ TestLearningToolDataFormats.test_normalize_unicode_text_function _______

self = <src.test.test_learning_tool_static.TestLearningToolDataFormats object at 0x723d31338820>

    def test_normalize_unicode_text_function(self):
        """Проверка функции normalize_unicode_text"""
        from src.tools.learning_tool import normalize_unicode_text
    
        # Тест с обычным текстом
        assert normalize_unicode_text("Hello World") == "hello world"
    
        # Тест с Unicode символами
        result = normalize_unicode_text("Тест naïve résumé")
        assert "тест" in result
        assert "naive" in result  # без диакритических знаков
        assert "resume" in result  # без диакритических знаков
    
        # Тест с пустой строкой
        assert normalize_unicode_text("") == ""
    
        # Тест с None
>       assert normalize_unicode_text(None) == ""
E       AssertionError: assert None == ''
E        +  where None = <function normalize_unicode_text at 0x723d31331bd0>(None)

src/test/test_learning_tool_static.py:420: AssertionError
____________ TestLearningToolDataFormats.test_none_values_handling _____________

self = <src.test.test_learning_tool_static.TestLearningToolDataFormats object at 0x723d31339120>

    def test_none_values_handling(self):
        """Проверка обработки None значений"""
        from src.tools.learning_tool import LearningTool
    
        with tempfile.TemporaryDirectory() as tmp_dir:
            tool = LearningTool(experience_dir=tmp_dir)
    
            # Добавляем задачу с None значениями
>           tool.save_task_experience(
                task_id=None,
                task_description=None,
                success=None
            )

src/test/test_learning_tool_static.py:471: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = LearningTool(name='LearningTool', description='Tool Name: LearningTool\nTool Arguments: {\n  "properties": {\n    "act...ence_file=PosixPath('/tmp/tmpteun19j5/experience.json'), enable_indexing=True, cache_size=1000, cache_ttl_seconds=3600)
task_id = None, task_description = None, success = None, execution_time = None
notes = '', patterns = None

    def save_task_experience(self, task_id: str, task_description: str,
                           success: bool, execution_time: Optional[float] = None,
                           notes: str = "", patterns: List[str] = None) -> str:
        """
        Сохранение опыта выполнения задачи
    
        Args:
            task_id: ID задачи
            task_description: Описание задачи
            success: Успешность выполнения
            execution_time: Время выполнения в секундах
            notes: Дополнительные заметки
            patterns: Паттерны/шаблоны задачи
    
        Returns:
            Сообщение о сохранении
        """
        # Валидация входных параметров
        if not task_id or not isinstance(task_id, str):
>           raise ValueError("task_id must be a non-empty string")
E           ValueError: task_id must be a non-empty string

src/tools/learning_tool.py:213: ValueError
_________ TestSmartAgentStatic.test_create_smart_agent_parameter_types _________

self = <src.test.test_smart_agent_static.TestSmartAgentStatic object at 0x723d316ef9d0>

    def test_create_smart_agent_parameter_types(self):
        """Проверка типов параметров create_smart_agent"""
        from src.agents.smart_agent import create_smart_agent
    
        sig = inspect.signature(create_smart_agent)
        params = sig.parameters
    
        # Проверяем типы параметров
        assert params['project_dir'].annotation == Path
>       assert params['docs_dir'].annotation == 'Optional[Path]'
E       assert typing.Optional[pathlib.Path] == 'Optional[Path]'
E        +  where typing.Optional[pathlib.Path] = <Parameter "docs_dir: Optional[pathlib.Path] = None">.annotation

src/test/test_smart_agent_static.py:47: AssertionError
___________ TestSmartAgentStatic.test_create_smart_agent_return_type ___________

self = <src.test.test_smart_agent_static.TestSmartAgentStatic object at 0x723d31338c40>

    def test_create_smart_agent_return_type(self):
        """Проверка типа возвращаемого значения create_smart_agent"""
        from src.agents.smart_agent import create_smart_agent
    
        # Проверяем аннотацию возвращаемого типа
        sig = inspect.signature(create_smart_agent)
>       assert sig.return_annotation == 'Agent'
E       AssertionError: assert <class 'crewai.agent.core.Agent'> == 'Agent'
E        +  where <class 'crewai.agent.core.Agent'> = <Signature (project_dir: pathlib.Path, docs_dir: Optional[pathlib.Path] = None, experience_dir: str = 'smart_experienc... True, llm_config_path: str = 'config/llm_settings.yaml', max_experience_tasks: int = 1000) -> crewai.agent.core.Agent>.return_annotation

src/test/test_smart_agent_static.py:84: AssertionError
__________ TestSmartAgentStatic.test_smart_agent_no_llm_configuration __________

self = <src.test.test_smart_agent_static.TestSmartAgentStatic object at 0x723d3133a740>

    def test_smart_agent_no_llm_configuration(self):
        """Проверка конфигурации Smart Agent без LLM"""
        from src.agents.smart_agent import create_smart_agent
    
        with patch('src.tools.docker_utils.is_docker_available', return_value=False):
            with patch('src.llm.crewai_llm_wrapper.create_llm_for_crewai', return_value=None):
                with tempfile.TemporaryDirectory() as tmp_dir:
                    project_dir = Path(tmp_dir)
    
                    # Тест без LLM
                    agent_no_llm = create_smart_agent(
                        project_dir=project_dir,
                        use_llm=False,
                        verbose=False
                    )
    
                    assert agent_no_llm is not None
>                   assert agent_no_llm.llm is None
E                   assert <crewai.llms.providers.openai.completion.OpenAICompletion object at 0x723cf7206320> is None
E                    +  where <crewai.llms.providers.openai.completion.OpenAICompletion object at 0x723cf7206320> = Agent(role=Smart Project Executor Agent, goal=Execute complex tasks with enhanced intelligence, learning from previous...nce data to provide better recommendations for similar tasks.\nOperating without code execution and in tool-only mode.\n).llm

src/test/test_smart_agent_static.py:214: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  src.agents.smart_agent:smart_agent.py:205 ⚠️  Limited functionality: no code execution, tool-only mode
__________ TestSmartAgentStatic.test_smart_agent_docker_configuration __________

self = <src.test.test_smart_agent_static.TestSmartAgentStatic object at 0x723d3133aa40>

    def test_smart_agent_docker_configuration(self):
        """Проверка конфигурации Docker в Smart Agent"""
        from src.agents.smart_agent import create_smart_agent
    
        with patch('src.tools.docker_utils.is_docker_available', return_value=True):
            with patch('src.llm.crewai_llm_wrapper.create_llm_for_crewai', return_value=None):
                with tempfile.TemporaryDirectory() as tmp_dir:
                    project_dir = Path(tmp_dir)
    
                    # Тест с Docker
                    agent_with_docker = create_smart_agent(
                        project_dir=project_dir,
                        use_docker=True,
                        allow_code_execution=True,
                        use_llm=False,
                        verbose=False
                    )
    
                    assert agent_with_docker is not None
>                   assert agent_with_docker.allow_code_execution == True
E                   assert False == True
E                    +  where False = Agent(role=Smart Project Executor Agent, goal=Execute complex tasks with enhanced intelligence, learning from previous...nce data to provide better recommendations for similar tasks.\nOperating without code execution and in tool-only mode.\n).allow_code_execution

src/test/test_smart_agent_static.py:235: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  src.agents.smart_agent:smart_agent.py:205 ⚠️  Limited functionality: no code execution, tool-only mode
________ TestSmartAgentStatic.test_smart_agent_experience_dir_creation _________

self = <src.test.test_smart_agent_static.TestSmartAgentStatic object at 0x723d3133b040>

    def test_smart_agent_experience_dir_creation(self):
        """Проверка создания директории опыта"""
        from src.agents.smart_agent import create_smart_agent
    
        with patch('src.tools.docker_utils.is_docker_available', return_value=False):
            with patch('src.llm.crewai_llm_wrapper.create_llm_for_crewai', return_value=None):
                with tempfile.TemporaryDirectory() as tmp_dir:
                    project_dir = Path(tmp_dir)
                    experience_dir = "custom_experience_dir"
    
                    agent = create_smart_agent(
                        project_dir=project_dir,
                        experience_dir=experience_dir,
                        use_llm=False,
                        verbose=False
                    )
    
                    assert agent is not None
    
                    # Проверяем что директория опыта создана
                    experience_path = project_dir / experience_dir
>                   assert experience_path.exists()
E                   AssertionError: assert False
E                    +  where False = exists()
E                    +    where exists = PosixPath('/tmp/tmp5oq1joym/custom_experience_dir').exists

src/test/test_smart_agent_static.py:287: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  src.agents.smart_agent:smart_agent.py:205 ⚠️  Limited functionality: no code execution, tool-only mode
=========================== short test summary info ============================
FAILED src/test/test_context_analyzer_static.py::TestContextAnalyzerToolStatic::test_supported_extensions_list
FAILED src/test/test_context_analyzer_static.py::TestContextAnalyzerToolStatic::test_context_analyzer_initialization
FAILED src/test/test_context_analyzer_static.py::TestContextAnalyzerToolFormats::test_normalize_unicode_text_function
FAILED src/test/test_context_analyzer_static.py::TestContextAnalyzerToolErrorHandling::test_context_analyzer_get_task_context_empty_query
FAILED src/test/test_learning_tool_static.py::TestLearningToolStatic::test_learning_tool_initialization
FAILED src/test/test_learning_tool_static.py::TestLearningToolDataFormats::test_normalize_unicode_text_function
FAILED src/test/test_learning_tool_static.py::TestLearningToolDataFormats::test_none_values_handling
FAILED src/test/test_smart_agent_static.py::TestSmartAgentStatic::test_create_smart_agent_parameter_types
FAILED src/test/test_smart_agent_static.py::TestSmartAgentStatic::test_create_smart_agent_return_type
FAILED src/test/test_smart_agent_static.py::TestSmartAgentStatic::test_smart_agent_no_llm_configuration
FAILED src/test/test_smart_agent_static.py::TestSmartAgentStatic::test_smart_agent_docker_configuration
FAILED src/test/test_smart_agent_static.py::TestSmartAgentStatic::test_smart_agent_experience_dir_creation
======================== 12 failed, 61 passed in 4.59s =========================
