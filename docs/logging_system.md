# Система логирования Code Agent

## 🚀 Быстрый старт

### Запуск сервера

```bash
python main.py
```

После запуска вы увидите:

```
================================================================================
CODE AGENT SERVER
================================================================================
🚀 ИНИЦИАЛИЗАЦИЯ
Время: 2026-01-18 14:30:22
Проект: d:\Space\codeAgent
Cursor CLI: ✅ Доступен
================================================================================
```

### Что происходит при выполнении задачи

#### 1. Начало итерации
```
────────────────────────────────────────────────────────────────────────────────
🔄 ИТЕРАЦИЯ 1
Ожидающих задач: 3
────────────────────────────────────────────────────────────────────────────────
```

#### 2. Начало задачи
```
╔══════════════════════════════════════════════════════════════════════════════╗
║ ЗАДАЧА 1/3: Добавить функцию валидации email
╚══════════════════════════════════════════════════════════════════════════════╝
```

#### 3. Фазы выполнения
```
📍 Анализ задачи
📍 ЭТАП 1, ИНСТРУКЦИЯ 1 - Генерация инструкции
📍 ЭТАП 1, ИНСТРУКЦИЯ 1 - Выполнение через Cursor
💬 Создан новый диалог
📍 Ожидание результата
📍 Завершение
```

#### 4. Результат

**Успех:**
```
✅ Ответ от Cursor: УСПЕШНО
   📄 Создано файлов: validators.py
   ✏️  Изменено файлов: utils.py
   🧪 Выполнено тестирование

================================================================================
✅ ЗАДАЧА УСПЕШНО ЗАВЕРШЕНА
Время выполнения: 12.5с
Инструкций выполнено: 1
================================================================================
```

**Ошибка:**
```
❌ Ответ от Cursor: ОШИБКА
   Причина: Таймаут выполнения

❌ ОШИБКА: Таймаут ожидания результата
   Тип: TimeoutError

================================================================================
❌ ЗАДАЧА ЗАВЕРШЕНА С ОШИБКОЙ
Время выполнения: 305.1с
================================================================================
```

### Где найти логи

#### Лог-файлы задач
```
logs/
  ├── task_task_1737207022_20260118_143022.log  ← Задача 1
  ├── task_task_1737207023_20260118_143145.log  ← Задача 2
  └── task_task_1737207024_20260118_143310.log  ← Задача 3
```

#### Общие логи
```
logs/
  ├── codeagent.log      ← Основной лог сервера
  ├── errors.log         ← Только ошибки
  └── tests.log          ← Логи тестов
```

---

## Обзор

Сервер Code Agent использует комплексную систему логирования, которая обеспечивает детальное отслеживание всех операций и упрощает диагностику проблем.

## Структура логирования

### 1. Лог-файлы по задачам

Каждая задача получает свой отдельный лог-файл:

```
logs/
  ├── task_task_1234567890_20260118_143022.log
  ├── task_task_1234567891_20260118_143145.log
  └── ...
```

**Формат имени:** `task_{task_id}_{timestamp}.log`

**Содержимое:**
- Полная информация о выполнении задачи
- Все фазы выполнения
- Инструкции для Cursor
- Ответы от агентов (полный stdout/stderr)
- Информация о созданных/измененных файлах
- Ошибки и их трассировки
- Время выполнения каждой фазы

### 2. Общие лог-файлы

Помимо задач, ведутся общие логи:

```
logs/
  ├── codeagent.log      # Основной лог сервера
  ├── errors.log         # Только ошибки
  └── tests.log          # Логи тестов
```

## Вывод в консоль

### Инициализация сервера

```
================================================================================
CODE AGENT SERVER
================================================================================
🚀 ИНИЦИАЛИЗАЦИЯ
Время: 2026-01-18 14:30:22
Проект: d:\Space\codeAgent
Документация: d:\Space\codeAgent\docs
Cursor CLI: ✅ Доступен
================================================================================
```

### Начало итерации

```
────────────────────────────────────────────────────────────────────────────────
🔄 ИТЕРАЦИЯ 1
Ожидающих задач: 3
Время: 14:30:25
────────────────────────────────────────────────────────────────────────────────
```

### Выполнение задачи

```
╔══════════════════════════════════════════════════════════════════════════════╗
║ ЗАДАЧА 1/3: Добавить функцию валидации email
╚══════════════════════════════════════════════════════════════════════════════╝

────────────────────────────────────────────────────────────────────────────────
📍 ЭТАП 1, ИНСТРУКЦИЯ 1 - Генерация инструкции
────────────────────────────────────────────────────────────────────────────────

📝 Инструкция 1 (тип: development)
   Выполни задачу: Добавить функцию валидации email...

────────────────────────────────────────────────────────────────────────────────
📍 ЭТАП 1, ИНСТРУКЦИЯ 1 - Выполнение через Cursor
────────────────────────────────────────────────────────────────────────────────

💬 Создан новый диалог

✅ Ответ от Cursor: УСПЕШНО
   📄 Создано файлов: validators.py
   ✏️  Изменено файлов: utils.py
   🧪 Выполнено тестирование

────────────────────────────────────────────────────────────────────────────────
📍 ЭТАП 1, ИНСТРУКЦИЯ 1 - Ожидание результата
────────────────────────────────────────────────────────────────────────────────

⏳ Ожидание результата...
   Файл: docs/results/result_task_1234567890.md
   Таймаут: 600с

✅ Результат получен (за 5.2с)
   Файл: docs/results/result_task_1234567890.md
   Превью: Функция валидации email успешно добавлена...

────────────────────────────────────────────────────────────────────────────────
📍 Завершение
────────────────────────────────────────────────────────────────────────────────

================================================================================
✅ ЗАДАЧА УСПЕШНО ЗАВЕРШЕНА
Время выполнения: 12.5с
Инструкций выполнено: 1
================================================================================
```

### Ошибка выполнения

```
❌ Ответ от Cursor: ОШИБКА
   Причина: Таймаут выполнения (300 секунд)

❌ ОШИБКА: Таймаут ожидания результата
   Тип: TimeoutError
   Детали: Файл результата не получен в течение 300 секунд

================================================================================
❌ ЗАДАЧА ЗАВЕРШЕНА С ОШИБКОЙ
Время выполнения: 305.1с
Инструкций выполнено: 1
Резюме: Ошибка: Таймаут ожидания результата
================================================================================
```

### Остановка сервера

```
================================================================================
🛑 СЕРВЕР ОСТАНОВЛЕН
Причина: Остановка пользователем (Ctrl+C)
Время: 2026-01-18 14:45:30
================================================================================
```

## Фазы выполнения задачи

Каждая задача проходит через следующие фазы:

1. **Инициализация** - Создание логгера, подготовка окружения
2. **Анализ задачи** - Определение типа задачи, выбор интерфейса
3. **Генерация инструкции** - Формирование инструкции из шаблона
4. **Выполнение через Cursor** - Отправка инструкции агенту
5. **Ожидание результата** - Ожидание файла результата
6. **Обработка результата** - Парсинг и анализ результата
7. **Завершение** - Обновление статусов, закрытие логгера
8. **Ошибка** - Обработка ошибок на любом этапе

## Информация в логах

### Краткая информация (консоль)

- Текущая фаза выполнения
- Номер задачи и этапа
- Краткое описание действий
- Статус выполнения (успех/ошибка)
- Основные результаты (созданные файлы, тесты)
- Время выполнения

### Детальная информация (файл)

- Полный текст инструкций
- Полный stdout/stderr от Cursor
- Трассировки ошибок
- Временные метки всех операций
- Содержимое файлов результатов
- Отладочная информация

## Анализ инцидентов

### Поиск проблемной задачи

1. Найти лог-файл задачи по времени или task_id:
   ```bash
   ls -lt logs/task_*.log | head -5
   ```

2. Открыть файл и найти секцию с ошибкой:
   ```
   ❌ ОШИБКА: ...
   ```

### Типичные проблемы

#### Таймаут ожидания результата

**Симптомы:**
```
❌ ОШИБКА: Таймаут ожидания результата
```

**Причины:**
- Cursor не завершил выполнение в срок
- Файл результата не был создан
- Контрольная фраза не найдена в файле

**Решение:**
- Увеличить таймаут в конфигурации
- Проверить шаблон инструкции
- Убедиться, что Cursor создает файл результата

#### Ошибка Cursor CLI

**Симптомы:**
```
❌ Ответ от Cursor: ОШИБКА
   Причина: CLI вернул код 1
```

**Причины:**
- Cursor CLI недоступен
- Ошибка в инструкции
- Проблемы с правами доступа

**Решение:**
- Проверить доступность Cursor CLI
- Проверить корректность инструкции
- Проверить логи Cursor

#### Ошибка парсинга ответа

**Симптомы:**
```
❌ ОШИБКА: Не удалось извлечь информацию о файлах
```

**Причины:**
- Неожиданный формат ответа от Cursor
- Изменился формат вывода

**Решение:**
- Проверить полный stdout в лог-файле
- Обновить парсер ответов

## Конфигурация логирования

Настройки логирования находятся в `config/logging.yaml`:

```yaml
formatters:
  default:
    format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
  detailed:
    format: '%(asctime)s - %(name)s - %(levelname)s - [%(filename)s:%(lineno)d] - %(message)s'

handlers:
  console:
    level: INFO  # Уровень для консоли
  file:
    level: DEBUG  # Уровень для файла
    maxBytes: 10485760  # 10MB
    backupCount: 5
```

### Изменение уровня логирования

Для более детального вывода в консоль:

```yaml
handlers:
  console:
    level: DEBUG  # Было: INFO
```

Для меньшего вывода:

```yaml
handlers:
  console:
    level: WARNING  # Только предупреждения и ошибки
```

## API логирования

### TaskLogger

```python
from src.task_logger import TaskLogger, TaskPhase

# Создание логгера для задачи
logger = TaskLogger(task_id="task_123", task_name="Моя задача")

# Установка фазы
logger.set_phase(TaskPhase.CURSOR_EXECUTION, stage=1, instruction_num=1)

# Логирование инструкции
logger.log_instruction(1, "Текст инструкции", "development")

# Логирование ответа от Cursor
logger.log_cursor_response({
    'success': True,
    'stdout': '...',
    'stderr': ''
}, brief=True)

# Логирование создания диалога
logger.log_new_chat(chat_id="chat_456")

# Логирование ошибки
logger.log_error("Описание ошибки", exception=e)

# Завершение задачи
logger.log_completion(success=True, summary="Задача выполнена")
logger.close()
```

### ServerLogger

```python
from src.task_logger import ServerLogger

# Создание логгера сервера
logger = ServerLogger()

# Логирование инициализации
logger.log_initialization({
    'project_dir': '/path/to/project',
    'cursor_cli_available': True
})

# Логирование итерации
logger.log_iteration_start(iteration=1, pending_tasks=5)

# Логирование начала задачи
logger.log_task_start(task_number=1, total_tasks=5, task_name="Задача 1")

# Логирование остановки
logger.log_server_shutdown(reason="Остановка пользователем")
```

## Примеры использования

### Просмотр последних логов задач

```bash
# Windows
dir logs\task_*.log /O-D | more

# Linux/Mac
ls -lt logs/task_*.log | head -10
```

### Поиск ошибок

```bash
# Windows
findstr /C:"ОШИБКА" logs\task_*.log

# Linux/Mac
grep "ОШИБКА" logs/task_*.log
```

### Анализ времени выполнения

```bash
# Windows
findstr /C:"Время выполнения" logs\task_*.log

# Linux/Mac
grep "Время выполнения" logs/task_*.log
```

### Поиск успешных задач

```bash
# Windows
findstr /C:"УСПЕШНО ЗАВЕРШЕНА" logs\task_*.log

# Linux/Mac
grep "УСПЕШНО ЗАВЕРШЕНА" logs/task_*.log
```

## Ротация логов

Лог-файлы автоматически ротируются при достижении 10MB:

- Максимальный размер файла: 10MB
- Количество backup файлов: 5
- Старые файлы автоматически удаляются

Пример:
```
codeagent.log       # Текущий
codeagent.log.1     # Предыдущий
codeagent.log.2
codeagent.log.3
codeagent.log.4
codeagent.log.5     # Самый старый
```

## Рекомендации

1. **Регулярно проверяйте логи** - особенно при возникновении проблем
2. **Используйте task-specific логи** - для детального анализа конкретной задачи
3. **Настройте уровень логирования** - в зависимости от потребностей
4. **Архивируйте старые логи** - для освобождения места
5. **Используйте grep/findstr** - для быстрого поиска информации

## Интеграция с мониторингом

Логи можно интегрировать с системами мониторинга:

- **ELK Stack** - для централизованного хранения и анализа
- **Grafana Loki** - для визуализации логов
- **Sentry** - для отслеживания ошибок
- **CloudWatch** - для AWS окружения

## Troubleshooting

### Логи не создаются

**Проверить:**
1. Существует ли директория `logs/`
2. Есть ли права на запись
3. Корректна ли конфигурация в `logging.yaml`

### Слишком много логов

**Решение:**
1. Увеличить `maxBytes` в конфигурации
2. Уменьшить `backupCount`
3. Настроить автоматическую очистку старых логов

### Кириллица отображается некорректно

**Решение:**
1. Убедиться, что используется UTF-8 encoding
2. Проверить настройки консоли (Windows: `chcp 65001`)
3. Использовать редактор с поддержкой UTF-8

## 📚 Смотрите также

- **[Система контрольных точек](checkpoint_recovery.md)** - Восстановление после сбоев и автоматическое продолжение работы
- **[Цвета логирования](logging_colors.md)** - Система цветового кодирования для различных типов сообщений
- **[Мониторинг сервера](guides/server_monitoring_guide.md)** - Мониторинг работы сервера и диагностика проблем
