# Проверка API ключа OpenRouter

## Текущий статус

**Все компоненты используют один и тот же ключ из `.env` файла:**

- ✅ `.env` файл: `sk-or-v1-0968474c266b0bfe2907e...988a6f5166`
- ✅ Тесты: `sk-or-v1-0968474c266b0bfe2907e...988a6f5166`
- ✅ Сервер (LLMManager): `sk-or-v1-0968474c266b0bfe2907e...988a6f5166`

## Как проверить какой ключ используется

### Быстрая проверка
```bash
python test/verify_api_key.py
```

### Полная проверка
```bash
python test/check_api_key.py
```

### Сравнение ключей в тестах и сервере
```bash
python test/compare_keys.py
```

## Исправления применены

### 1. Принудительная перезагрузка переменных окружения

Во всех местах, где используется API ключ, добавлен `load_dotenv(override=True)`:

- ✅ `test/test_openrouter_api.py`
- ✅ `test/test_openrouter_detailed.py`
- ✅ `src/llm/llm_manager.py`
- ✅ `src/llm/model_discovery.py`
- ✅ `src/config_loader.py`

Это гарантирует, что всегда используется актуальный ключ из `.env` файла.

### 2. Логирование используемого ключа

В `LLMManager._init_clients()` добавлено логирование:
```python
logger.debug(f"Initialized {default_provider} client with API key: {api_key[:20]}...{api_key[-10:]}")
```

## Важные замечания

1. **Если сервер уже запущен** - он использует ключ, который был загружен при старте
   - Для применения нового ключа нужно перезапустить сервер

2. **Если тесты запускаются через `run_tests.py`** - каждый тест перезагружает переменные окружения

3. **Ключ в конфиге** - не используется (правильно, для безопасности)

## Проверка работающего сервера

Если сервер уже запущен и нужно проверить какой ключ он использует:

1. Проверьте логи сервера при запуске
2. Или перезапустите сервер для применения нового ключа

## Обновление ключа

1. Обновите ключ в `.env` файле
2. Перезапустите сервер (если запущен)
3. Запустите тесты - они автоматически подхватят новый ключ
