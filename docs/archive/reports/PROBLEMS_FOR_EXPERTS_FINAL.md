# ПРОБЛЕМЫ CURSOR CLI В DOCKER - ОТЧЕТ ДЛЯ ЭКСПЕРТОВ

**Дата:** 2026-01-18  
**Версия Cursor CLI:** Последняя (установлена через `curl https://cursor.com/install`)  
**Среда:** Docker (Ubuntu 22.04) на Windows  
**Статус:** ⚠️ Требуется помощь экспертов

---

## КРАТКОЕ ОПИСАНИЕ ПРОБЛЕМЫ

Cursor CLI (`agent`) работает в Docker контейнере через `script -q -c`, но:
1. **Простые команды** выполняются успешно (код 0), но часто **без видимого результата**
2. **Сложные команды** (создание файлов, анализ документации) выполняются с кодом 0, но **задачи не выполняются**
3. Иногда появляется ошибка "Unterminated quoted string" в stdout (но код возврата 0)

---

## ТЕХНИЧЕСКАЯ ИНФОРМАЦИЯ

### Окружение

- **Docker образ:** `ubuntu:22.04`
- **Контейнер:** `cursor-agent-life` (persistent, запущен через `docker compose up -d`)
- **Установка agent:** `curl https://cursor.com/install | bash`
- **Путь к agent:** `/root/.local/bin/agent`
- **Рабочая директория в контейнере:** `/workspace` (mount из `d:/Space/life`)

### Команда выполнения

```bash
docker exec -i cursor-agent-life bash -c \
  "export LANG=C.utf8 LC_ALL=C.utf8 && cd /workspace && \
   script -q -c \"agent_cmd='/root/.local/bin/agent -p \"простая инструкция\"; \$agent_cmd\" /dev/null"
```

**Примечание:** `script -q -c` используется для создания pseudo-TTY (обход требования Ink library).

---

## ПРОБЛЕМА #1: КОМАНДЫ ВЫПОЛНЯЮТСЯ, НО ЗАДАЧИ НЕ ВЫПОЛНЯЮТСЯ

### Симптомы

1. **Простая команда:** `agent -p "hello"`
   - Exit code: **0** ✅
   - Stdout: **пустой или минимальный** ⚠️
   - Stderr: **пустой** ✅
   - **Вывод:** Команда выполняется, но нет видимого ответа agent

2. **Сложная команда:** `agent -p "Создай файл test.txt с текстом Hello"`
   - Exit code: **0** ✅
   - Stdout: **пустой или минимальный** ⚠️
   - Stderr: **пустой** ✅
   - **Файл не создан** ❌

### Вопросы для экспертов

1. **Правильно ли мы используем `agent -p` для non-interactive режима?**
   - Есть ли другие флаги для headless режима?
   - Требуется ли дополнительная настройка для выполнения задач?

2. **Почему нет вывода в stdout?**
   - Должен ли `agent -p` выводить что-то в stdout?
   - Или вывод идет в другое место (файлы, логи)?

3. **Работает ли `agent -p` в неинтерактивном режиме?**
   - Или он все равно требует интерактивности для выполнения задач?

---

## ПРОБЛЕМА #2: "UNTERMINATED QUOTED STRING" В НЕКОТОРЫХ СЛУЧАЯХ

### Симптомы

В stdout иногда появляется:
```
sh: 1: Syntax error: Unterminated quoted string
```

Но код возврата все равно **0**, что странно.

### Техническая деталь

Команда формируется так:
```python
agent_cmd_simple = '/root/.local/bin/agent -p "инструкция с кавычками"'
escaped_cmd = agent_cmd_simple.replace("'", "'\"'\"'")
script_cmd = f'script -q -c "agent_cmd=\'{escaped_cmd}\'; $agent_cmd" /dev/null'
```

### Вопросы для экспертов

1. **Правильно ли экранирование?**
   - Нужен ли другой подход для передачи команды в `script -c`?
   - Может быть, лучше использовать файл или другой метод передачи?

---

## ПРОБЛЕМА #3: РУССКИЙ ТЕКСТ В ИНСТРУКЦИЯХ

### Симптомы

Инструкции на русском языке передаются, но:
- Команды выполняются (код 0)
- Задачи не выполняются (файлы не создаются)

### Техническая деталь

- Locale установлен: `LANG=C.utf8 LC_ALL=C.utf8`
- Нормализация: переносы строк заменяются на пробелы
- Экранирование: через bash переменную в `script -c`

### Вопросы для экспертов

1. **Поддерживает ли `agent -p` русский текст?**
   - Нужна ли дополнительная настройка для UTF-8?

---

## РЕЗУЛЬТАТЫ ТЕСТИРОВАНИЯ

### Тест 1: Простая команда (`hello`)

```python
cli.execute('hello', new_chat=True)
```

**Результат:**
- Exit code: **0** ✅
- Success: **True** ✅
- Stdout: **пустой** ⚠️
- Stderr: **пустой** ✅

**Вывод:** Команда выполняется, но нет видимого ответа от agent.

---

### Тест 2: Создание файла (русский текст)

```python
cli.execute('Создай файл test.txt с текстом Hello', new_chat=True)
```

**Результат:**
- Exit code: **0** ✅
- Success: **True** ✅
- Stdout: **"sh: 1: Syntax error: Unterminated quoted string"** ⚠️
- Stderr: **пустой** ✅
- **Файл не создан** ❌

**Вывод:** Команда выполняется, но задача не выполняется. Есть ошибка экранирования в stdout.

---

### Тест 3: Сложная инструкция (429 символов)

```python
cli.execute('Ты архитектор. Проанализируй документацию...', new_chat=True)
```

**Результат:**
- Exit code: **0** ✅
- Success: **True** ✅
- Stdout: **пустой** ⚠️
- Stderr: **пустой** ✅
- **Файл `mini_docs_for_user.md` не создан** ❌

**Вывод:** Команда выполняется, но сложные задачи не выполняются.

---

### Тест 4: Прямой запуск agent (без script)

```bash
docker exec cursor-agent-life /root/.local/bin/agent -p "hello"
```

**Результат:** 
- Exit code: **137** (SIGKILL) ❌
- Ошибка: **"Raw mode is not supported"** (Ink library требует TTY)

**Вывод:** `script` необходим для обхода требования Ink library к TTY.

---

### Тест 5: Список чатов

```bash
docker exec cursor-agent-life /root/.local/bin/agent ls
```

**Результат:**
- Exit code: **0** ✅
- Stdout: **содержит список чатов** ✅
- Stderr: **содержит ошибку Ink** ⚠️ (но команда работает)

**Вывод:** `agent ls` работает, но выводит ошибку Ink в stderr.

---

## ЛОГИ

Логи контейнера доступны через:
```bash
docker logs cursor-agent-life
```

Но там нет вывода от `agent -p` команд (возможно, вывод идет в другое место).

---

## ВОПРОСЫ ДЛЯ ЭКСПЕРТОВ CURSOR

1. **Как правильно использовать `agent` CLI в non-interactive режиме?**
   - Есть ли документация для headless использования?
   - Какие флаги нужны?

2. **Почему `agent -p` не выполняет задачи?**
   - Это ожидаемое поведение или баг?
   - Нужна ли дополнительная настройка?

3. **Куда идет вывод `agent -p`?**
   - В stdout?
   - В файлы?
   - В логи?

4. **Требуется ли TTY для `agent -p`?**
   - Мы используем `script` для pseudo-TTY
   - Это правильно или есть лучший способ?

5. **Поддерживается ли `agent -p` для создания файлов и выполнения задач?**
   - Или он только для простых запросов?

---

## ПРИМЕРЫ КОМАНД

### Что работает

```bash
# Список чатов
docker exec cursor-agent-life /root/.local/bin/agent ls
```

### Что не работает как ожидается

```bash
# Простая команда (код 0, но нет вывода)
docker exec cursor-agent-life bash -c \
  'script -q -c "agent_cmd=\"/root/.local/bin/agent -p hello\"; \$agent_cmd" /dev/null'

# Создание файла (код 0, но файл не создан)
docker exec cursor-agent-life bash -c \
  'cd /workspace && script -q -c "agent_cmd=\"/root/.local/bin/agent -p Создай файл test.txt\"; \$agent_cmd" /dev/null'
```

---

## КОНТЕКСТ

Мы разрабатываем **Code Agent** - систему автоматизации для работы с проектами через Cursor CLI. Нам нужно:
- Автоматически отправлять инструкции в `agent`
- Получать результаты выполнения (создание файлов, изменения кода)
- Работать в headless режиме (без интерактивности)

---

## ДОПОЛНИТЕЛЬНАЯ ИНФОРМАЦИЯ

- **GitHub проекта:** [Code Agent]
- **Документация Cursor CLI:** Ищем актуальную документацию
- **Версия agent:** Последняя (установлена через официальный скрипт)

---

**Статус:** ⚠️ **ТРЕБУЕТСЯ ПОМОЩЬ ЭКСПЕРТОВ CURSOR**

**Контакты для обратной связи:** Готовы предоставить дополнительную информацию по запросу.
