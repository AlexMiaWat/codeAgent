# Реализация системы логирования Code Agent

## Обзор изменений

Реализована комплексная система логирования для сервера Code Agent, которая обеспечивает:

1. ✅ **Отдельный лог-файл для каждой задачи** - один файл на одну задачу
2. ✅ **Регистрация ответов от агентов (Cursor)** - полные stdout/stderr в файле, краткие резюме в консоли
3. ✅ **Отображение переходов между этапами** - четкая индикация фаз выполнения
4. ✅ **Последовательный вывод в консоль** - структурированная информация о ходе выполнения
5. ✅ **Краткие ответы от агентов** - тезисные резюме с указанием созданных/измененных файлов
6. ✅ **Информация о создании новых диалогов** - логирование chat_id
7. ✅ **Важная информация для разбора инцидентов** - детальные логи с трассировками ошибок

## Новые файлы

### 1. `src/task_logger.py`

Модуль с двумя основными классами:

#### `TaskLogger`
- Создает отдельный лог-файл для каждой задачи
- Формат: `logs/task_{task_id}_{timestamp}.log`
- Ведет детальное логирование всех операций
- Выводит краткую информацию в консоль

**Основные методы:**
- `set_phase()` - установка текущей фазы выполнения
- `log_instruction()` - логирование инструкции для Cursor
- `log_cursor_response()` - логирование ответа от агента
- `log_new_chat()` - логирование создания нового диалога
- `log_error()` - логирование ошибок с трассировкой
- `log_completion()` - логирование завершения задачи

#### `ServerLogger`
- Логирование общих операций сервера
- Инициализация, итерации, остановка

**Основные методы:**
- `log_initialization()` - инициализация сервера
- `log_iteration_start()` - начало итерации
- `log_task_start()` - начало выполнения задачи
- `log_server_shutdown()` - остановка сервера

#### `TaskPhase` (Enum)
Фазы выполнения задачи:
- INITIALIZATION - Инициализация
- TASK_ANALYSIS - Анализ задачи
- INSTRUCTION_GENERATION - Генерация инструкции
- CURSOR_EXECUTION - Выполнение через Cursor
- WAITING_RESULT - Ожидание результата
- RESULT_PROCESSING - Обработка результата
- COMPLETION - Завершение
- ERROR - Ошибка

### 2. `docs/logging_system.md`

Полная документация системы логирования:
- Структура лог-файлов
- Примеры вывода в консоль
- Описание фаз выполнения
- Руководство по анализу инцидентов
- API логирования
- Примеры использования

### 3. `test/test_task_logger.py`

Набор тестов для проверки системы логирования (15 тестов):
- Создание логгеров
- Логирование фаз
- Логирование инструкций и ответов
- Обработка ошибок
- Извлечение информации о файлах

## Изменения в существующих файлах

### `src/server.py`

Интеграция системы логирования:

1. **Импорт модулей логирования:**
```python
from .task_logger import TaskLogger, ServerLogger, TaskPhase
```

2. **Инициализация ServerLogger в `__init__`:**
```python
self.server_logger = ServerLogger()
self.server_logger.log_initialization({...})
```

3. **Обновление `_execute_task()`:**
- Добавлены параметры `task_number` и `total_tasks`
- Создается `TaskLogger` для каждой задачи
- Логирование начала задачи через `server_logger`
- Передача `task_logger` в методы выполнения
- Закрытие логгера после завершения

4. **Обновление `_execute_task_via_cursor()`:**
- Добавлен параметр `task_logger`
- Логирование всех фаз выполнения
- Логирование инструкций
- Логирование ответов от Cursor
- Логирование создания новых диалогов
- Логирование ожидания и получения результатов

5. **Обновление `_execute_task_via_crewai()`:**
- Добавлен параметр `task_logger`
- Логирование фаз выполнения через CrewAI

6. **Обновление `run_iteration()`:**
- Добавлен параметр `iteration`
- Логирование начала итерации
- Передача номеров задач в `_execute_task()`

7. **Обновление `start()`:**
- Передача номера итерации в `run_iteration()`
- Логирование остановки сервера

## Примеры вывода

### Инициализация сервера

```
================================================================================
CODE AGENT SERVER
================================================================================
🚀 ИНИЦИАЛИЗАЦИЯ
Время: 2026-01-18 14:30:22
Проект: d:\Space\codeAgent
Документация: d:\Space\codeAgent\docs
Cursor CLI: ✅ Доступен
================================================================================
```

### Выполнение задачи

```
╔══════════════════════════════════════════════════════════════════════════════╗
║ ЗАДАЧА 1/3: Добавить функцию валидации email
╚══════════════════════════════════════════════════════════════════════════════╝

────────────────────────────────────────────────────────────────────────────────
📍 ЭТАП 1, ИНСТРУКЦИЯ 1 - Генерация инструкции
────────────────────────────────────────────────────────────────────────────────

📝 Инструкция 1 (тип: development)
   Выполни задачу: Добавить функцию валидации email...

────────────────────────────────────────────────────────────────────────────────
📍 ЭТАП 1, ИНСТРУКЦИЯ 1 - Выполнение через Cursor
────────────────────────────────────────────────────────────────────────────────

💬 Создан новый диалог

✅ Ответ от Cursor: УСПЕШНО
   📄 Создано файлов: validators.py
   ✏️  Изменено файлов: utils.py
   🧪 Выполнено тестирование

================================================================================
✅ ЗАДАЧА УСПЕШНО ЗАВЕРШЕНА
Время выполнения: 12.5с
Инструкций выполнено: 1
================================================================================
```

### Структура лог-файла задачи

```
================================================================================
ЗАДАЧА: Добавить функцию валидации email
ID: task_1737207022
НАЧАЛО: 2026-01-18 14:30:22
================================================================================

────────────────────────────────────────────────────────────────────────────────
📍 Анализ задачи
────────────────────────────────────────────────────────────────────────────────

2026-01-18 14:30:22 - DEBUG - Тип задачи определен: development
2026-01-18 14:30:22 - DEBUG - Интерфейс: Cursor

────────────────────────────────────────────────────────────────────────────────
📍 ЭТАП 1, ИНСТРУКЦИЯ 1 - Генерация инструкции
────────────────────────────────────────────────────────────────────────────────

2026-01-18 14:30:22 - DEBUG - Инструкция 1:
2026-01-18 14:30:22 - DEBUG - Тип задачи: development
2026-01-18 14:30:22 - DEBUG - Полный текст:
Выполни задачу: Добавить функцию валидации email...

────────────────────────────────────────────────────────────────────────────────
📍 ЭТАП 1, ИНСТРУКЦИЯ 1 - Выполнение через Cursor
────────────────────────────────────────────────────────────────────────────────

2026-01-18 14:30:23 - DEBUG - Chat ID: N/A

========================================
ОТВЕТ ОТ CURSOR:
========================================
Успех: True
Код возврата: 0

STDOUT:
[полный вывод от Cursor]

STDERR:
[ошибки если есть]
========================================

================================================================================
✅ ЗАДАЧА УСПЕШНО ЗАВЕРШЕНА
Время выполнения: 12.5с
Инструкций выполнено: 1
================================================================================
```

## Преимущества новой системы

### 1. Отдельные логи для задач
- ✅ Легко найти информацию о конкретной задаче
- ✅ Не нужно искать в общем логе
- ✅ Можно архивировать/удалять логи старых задач

### 2. Структурированный вывод в консоль
- ✅ Четкое понимание текущего этапа
- ✅ Визуальное разделение задач и фаз
- ✅ Краткие резюме вместо полных логов

### 3. Детальная информация для отладки
- ✅ Полные stdout/stderr в файле
- ✅ Трассировки ошибок
- ✅ Временные метки всех операций
- ✅ Информация о созданных файлах

### 4. Удобство анализа инцидентов
- ✅ Быстрый поиск проблемной задачи
- ✅ Полная информация о контексте ошибки
- ✅ История выполнения задачи

### 5. Производительность
- ✅ Минимальное влияние на производительность
- ✅ Асинхронная запись в файл
- ✅ Автоматическая ротация логов

## Использование

### Запуск сервера

```bash
python main.py
```

Сервер автоматически:
1. Создаст директорию `logs/` если её нет
2. Инициализирует систему логирования
3. Создаст лог-файл для каждой задачи
4. Выведет структурированную информацию в консоль

### Просмотр логов задачи

```bash
# Windows
type logs\task_task_1737207022_20260118_143022.log

# Linux/Mac
cat logs/task_task_1737207022_20260118_143022.log
```

### Поиск ошибок

```bash
# Windows
findstr /C:"ОШИБКА" logs\task_*.log

# Linux/Mac
grep "ОШИБКА" logs/task_*.log
```

### Анализ времени выполнения

```bash
# Windows
findstr /C:"Время выполнения" logs\task_*.log

# Linux/Mac
grep "Время выполнения" logs/task_*.log
```

## Тестирование

Запуск тестов системы логирования:

```bash
pytest test/test_task_logger.py -v
```

Результат:
```
============================= test session starts =============================
test/test_task_logger.py::test_task_logger_creation PASSED               [  6%]
test/test_task_logger.py::test_task_logger_phases PASSED                 [ 13%]
test/test_task_logger.py::test_task_logger_instruction PASSED            [ 20%]
test/test_task_logger.py::test_task_logger_cursor_response PASSED        [ 26%]
test/test_task_logger.py::test_task_logger_error PASSED                  [ 33%]
test/test_task_logger.py::test_task_logger_completion PASSED             [ 40%]
test/test_task_logger.py::test_task_logger_new_chat PASSED               [ 46%]
test/test_task_logger.py::test_server_logger_initialization PASSED       [ 53%]
test/test_task_logger.py::test_server_logger_iteration PASSED            [ 60%]
test/test_task_logger.py::test_server_logger_task_start PASSED           [ 66%]
test/test_task_logger.py::test_server_logger_shutdown PASSED             [ 73%]
test/test_task_logger.py::test_task_logger_file_extraction PASSED        [ 80%]
test/test_task_logger.py::test_task_logger_multiple_instructions PASSED  [ 86%]
test/test_task_logger.py::test_task_logger_waiting_result PASSED         [ 93%]
test/test_task_logger.py::test_task_logger_result_received PASSED        [100%]

============================= 15 passed in 0.42s ==============================
```

## Конфигурация

Настройки логирования находятся в `config/logging.yaml`:

```yaml
handlers:
  console:
    level: INFO  # Уровень для консоли (INFO, DEBUG, WARNING, ERROR)
  file:
    level: DEBUG  # Уровень для файла
    maxBytes: 10485760  # 10MB - максимальный размер файла
    backupCount: 5  # Количество backup файлов
```

### Изменение уровня детализации

Для более детального вывода в консоль:
```yaml
console:
  level: DEBUG
```

Для меньшего вывода:
```yaml
console:
  level: WARNING
```

## Совместимость

- ✅ Python 3.8+
- ✅ Windows, Linux, macOS
- ✅ Поддержка UTF-8 (кириллица)
- ✅ Совместимость с существующей системой логирования

## Дальнейшие улучшения

Возможные улучшения в будущем:

1. **Интеграция с внешними системами:**
   - ELK Stack для централизованного хранения
   - Grafana Loki для визуализации
   - Sentry для отслеживания ошибок

2. **Расширенная аналитика:**
   - Статистика по времени выполнения задач
   - Анализ частоты ошибок
   - Отчеты о производительности

3. **Уведомления:**
   - Email при критических ошибках
   - Slack/Telegram уведомления
   - Webhook для интеграции с другими системами

4. **Веб-интерфейс:**
   - Просмотр логов через браузер
   - Поиск и фильтрация
   - Визуализация выполнения задач

## Заключение

Реализованная система логирования полностью соответствует требованиям:

✅ **Отдельный лог-файл на задачу** - каждая задача имеет свой файл с полной информацией

✅ **Регистрация ответов от агентов** - полные stdout/stderr в файле, краткие резюме в консоли

✅ **Переходы между этапами** - четкая индикация фаз выполнения с номерами этапов и инструкций

✅ **Последовательный вывод в консоль** - структурированная информация:
   - Инициализация
   - Выполнение задачи N, этап M, инструкция K
   - Тестирование и другие операции

✅ **Краткие ответы от агентов** - тезисные резюме:
   - "Выполнено - успешно"
   - "Создан файл X"
   - "Изменен файл Y"
   - "Протестировано"

✅ **Информация о новых диалогах** - логирование создания chat_id

✅ **Важная информация для инцидентов** - детальные логи с трассировками ошибок, временными метками, контекстом выполнения

Система готова к использованию и полностью протестирована!
