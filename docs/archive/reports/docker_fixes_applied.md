# Исправления Docker интеграции

**Дата:** 2026-01-18

## 1. Исправление передачи CURSOR_API_KEY из .env

### Проблема:
CURSOR_API_KEY не передавался в контейнер автоматически из `.env` файла.

### Решение:
Docker Compose автоматически загружает переменные из `.env` файла в той же директории, где находится `docker-compose.yml`. 

**Проверка:**
```bash
# Экспортируем переменную перед запуском
export CURSOR_API_KEY=$(grep CURSOR_API_KEY .env | cut -d= -f2)
docker compose -f docker/docker-compose.agent.yml up -d
```

**Проверка в контейнере:**
```bash
docker exec cursor-agent-life bash -c 'echo "CURSOR_API_KEY length: ${#CURSOR_API_KEY}"'
```

## 2. Установка UTF-8 локали в команде

### Проблема:
Локаль не устанавливалась при выполнении команд через `docker exec`, даже если была настроена в `docker-compose.agent.yml`.

### Решение:
Добавлена установка локали непосредственно в команду `bash -c`:

```python
cmd = [
    "docker", "exec",
    "-i",
    "cursor-agent-life",
    "bash", "-c",
    f'export LANG=C.utf8 LC_ALL=C.utf8 && cd /workspace && /root/.local/bin/agent -p \'{escaped_prompt}\''
]
```

**Преимущества:**
- Локаль устанавливается для каждой команды
- Рабочая директория устанавливается явно (`cd /workspace`)
- Гарантированная поддержка UTF-8 для кириллицы

## 3. Проверка формирования команды

### Текущая логика:
1. Экранирование prompt для bash:
   - Одинарные кавычки: `'` → `'"'"'`
   - Доллар: `$` → `\$`
   - Обратные кавычки: `` ` `` → `` \` ``

2. Формирование команды:
   ```python
   escaped_prompt = prompt.replace("'", "'\"'\"'").replace('$', '\\$').replace('`', '\\`')
   cmd_str = f'export LANG=C.utf8 LC_ALL=C.utf8 && cd /workspace && /root/.local/bin/agent -p \'{escaped_prompt}\''
   ```

### Тестирование:
- Простые команды (английский) - ✅ Работают
- Команды с кириллицей - ⚠️ Требуют проверки
- Длинные инструкции - ⚠️ Требуют проверки

## Результаты

### Успешно:
1. ✅ UTF-8 локаль устанавливается в команде
2. ✅ Рабочая директория устанавливается явно
3. ✅ Простые команды выполняются успешно

### Требует проверки:
1. ⚠️ CURSOR_API_KEY - нужно убедиться, что передается из .env
2. ⚠️ Длинные инструкции - код 137 все еще возникает
3. ⚠️ Кириллица - требует дополнительного тестирования

## Следующие шаги

1. Протестировать длинную инструкцию на английском с новой командой
2. Протестировать инструкцию с кириллицей
3. Проверить логи agent при выполнении длинных команд
4. Рассмотреть альтернативные способы передачи инструкций (через файл)
