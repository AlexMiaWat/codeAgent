# Тестирование LLMManager: JSON Mode и Fallback

## Обзор

Добавлены комплексные тесты для проверки работы LLMManager с JSON mode и fallback механизмом.

## Что тестируется

### 1. Базовый JSON mode (`test_json_mode_basic`)
- Проверка что модель возвращает валидный JSON при запросе с `response_format={"type": "json_object"}`
- Валидация структуры JSON (обязательные поля, типы данных)
- Проверка значений в допустимых диапазонах

### 2. Fallback при ошибках в JSON mode (`test_json_mode_fallback`)
- Проверка что fallback цепочка работает когда модель возвращает невалидный JSON
- Отслеживание статистики ошибок по моделям
- Проверка что финальный ответ валиден

### 3. Извлечение JSON из markdown (`test_json_extraction_from_markdown`)
- Проверка извлечения JSON из ответов обернутых в markdown code fences (```json ... ```)
- Обработка случаев когда модель игнорирует JSON mode и возвращает текст с JSON внутри

### 4. Множественные JSON запросы (`test_multiple_json_requests`)
- Проверка стабильности работы с разными JSON схемами
- Тестирование различных промптов и структур ответов

### 5. Проверка fallback цепочки (`test_fallback_chain_verification`)
- Проверка что все модели в fallback цепочке пробуются
- Отслеживание статистики использования моделей
- Валидация финального ответа

## Улучшения в LLMManager

### 1. Валидация JSON ответов
Добавлен метод `_validate_json_response()` который:
- Проверяет что ответ является валидным JSON объектом
- Извлекает JSON из markdown code fences
- Использует `json.JSONDecoder().raw_decode()` для надежного парсинга

### 2. Улучшенный fallback механизм
Метод `_generate_with_fallback()` теперь:
- Проверяет валидность JSON ответа когда запрашивается JSON mode
- Продолжает fallback цепочку если модель вернула невалидный JSON
- Логирует предупреждения о невалидных ответах

### 3. Улучшенная параллельная генерация
Метод `_generate_parallel()` теперь:
- Проверяет валидность JSON ответов перед выбором лучшего
- Использует fallback если обе модели вернули невалидный JSON

### 4. Обработка ошибок API
Улучшена обработка ответов от API:
- Проверка что `response.choices` не пустой
- Проверка что `message` не None
- Безопасное извлечение `content` с fallback на пустую строку

## Запуск тестов

```bash
python test/test_llm_json_mode.py
```

## Результаты тестирования

Все тесты должны проходить успешно:
- ✅ Базовый JSON mode
- ✅ Fallback при ошибках
- ✅ Извлечение JSON из markdown
- ✅ Множественные запросы
- ✅ Проверка fallback цепочки

## Известные ограничения

1. Некоторые модели (особенно маленькие) могут игнорировать `response_format` и возвращать обычный текст вместо JSON
2. Fallback механизм автоматически пробует следующую модель если текущая вернула невалидный JSON
3. Пустые JSON объекты `{}` считаются валидными, но могут не содержать нужных полей

## Рекомендации

1. Используйте модели из `primary` списка для лучшей поддержки JSON mode
2. Всегда проверяйте наличие обязательных полей в ответе
3. Используйте fallback модели для повышения надежности
4. Логируйте невалидные ответы для анализа проблемных моделей
