# Исправления тестов API

## Проблемы

1. **Сервер не запускается автоматически** - таймаут 30 секунд недостаточен
2. **Сервер не завершается после тестов** - процесс остается активным
3. **Нет диагностики ошибок** - не видно почему сервер не запускается
4. **Неправильная проверка доступности** - не учитываются все типы ошибок

## Исправления

### 1. Улучшена диагностика запуска сервера

**Проблема:** При неудачном запуске не было видно ошибок из stderr

**Решение:**
- Добавлено чтение stderr в фоне через отдельный поток
- Вывод ошибок в реальном времени (error, fail, exception)
- Вывод последних ошибок при неудачном запуске
- Проверка, что процесс не завершился сразу после запуска

**Код:**
```python
# Читаем stderr в фоне для диагностики
def read_stderr():
    for line in iter(self.server_process.stderr.readline, ''):
        if line:
            stderr_lines.append(line.strip())
            # Выводим важные ошибки сразу
            if any(keyword in line.lower() for keyword in ['error', 'fail', 'exception']):
                print(f"[STDERR] {line.strip()}")
```

### 2. Увеличен таймаут запуска

**Проблема:** 30 секунд недостаточно для запуска сервера

**Решение:**
- Увеличен таймаут с 30 до 45 секунд
- Улучшена проверка доступности - проверяется каждую секунду
- Добавлена проверка, что процесс не завершился

### 3. Улучшена остановка сервера

**Проблема:** Сервер не завершался после тестов

**Решение:**
- Сначала отправляется запрос через API `/stop` (graceful shutdown)
- Дается 10 секунд на graceful shutdown
- Если не завершился - принудительная остановка через `terminate()`
- Если и это не помогло - `kill()` с таймаутом
- Проверка, что процесс действительно завершился

**Код:**
```python
# Пробуем остановить через API (graceful shutdown)
try:
    response = requests.post(f"{self.base_url}/stop", timeout=5)
    # Даем время на graceful shutdown (10 секунд)
    for i in range(10):
        if self.server_process.poll() is not None:
            print(f"[OK] Процесс завершился gracefully")
            return
        time.sleep(1)
except:
    # Принудительная остановка
    self.server_process.terminate()
    self.server_process.wait(timeout=10)
```

### 4. Улучшена обработка ошибок подключения

**Проблема:** Не все типы ошибок обрабатывались правильно

**Решение:**
- Добавлена обработка `Timeout` ошибок
- Улучшена обработка `ConnectionError`
- Добавлены более информативные сообщения об ошибках
- Указание на проверку логов при неудачном запуске

### 5. Проверка процесса при запуске

**Проблема:** Не проверялось, что процесс не завершился сразу

**Решение:**
- Проверка через 2 секунды после запуска
- Если процесс завершился - вывод ошибок из stderr
- Проверка на каждой итерации ожидания

## Как работает теперь

### Запуск сервера

1. **Запуск процесса** через `subprocess.Popen`
2. **Чтение stderr в фоне** для диагностики
3. **Проверка процесса** - не завершился ли сразу
4. **Ожидание доступности** - проверка `/health` каждую секунду (до 45 секунд)
5. **Вывод ошибок** если сервер не запустился

### Остановка сервера

1. **Graceful shutdown** - запрос через API `/stop`
2. **Ожидание завершения** - до 10 секунд
3. **Принудительная остановка** - `terminate()` если не завершился
4. **Kill** - `kill()` если и terminate не помог
5. **Проверка завершения** - убеждаемся что процесс завершился

## Диагностика проблем

### Сервер не запускается

**Что проверять:**
1. Порт 3456 занят? Проверьте: `netstat -ano | findstr :3456` (Windows)
2. Ошибки в stderr - теперь выводятся автоматически
3. Логи сервера: `logs/codeagent.log`
4. Права доступа - может не хватать прав для запуска

**Что делать:**
- Запустите сервер вручную: `python main.py`
- Проверьте логи: `logs/codeagent.log`
- Проверьте порт: `netstat -ano | findstr :3456`

### Сервер не завершается

**Что проверять:**
1. Процесс все еще работает? Проверьте: `tasklist | findstr python` (Windows)
2. Порт все еще занят? Проверьте: `netstat -ano | findstr :3456`
3. Логи сервера - возможно сервер в долгой операции

**Что делать:**
- Остановите вручную: `taskkill /F /PID <pid>` (Windows)
- Или через API: `curl -X POST http://127.0.0.1:3456/stop`
- Проверьте логи: `logs/codeagent.log`

## Проверка исправлений

Запустите тесты:
```bash
python test/run_tests.py --api
```

Ожидаемое поведение:
1. ✅ Сервер запускается автоматически (если не запущен)
2. ✅ Видны ошибки из stderr при проблемах
3. ✅ Сервер завершается после тестов
4. ✅ Процесс не остается активным

## Дополнительные улучшения

### Рекомендуется добавить:

1. **Проверка порта перед запуском** - освобождение порта если занят
2. **Логирование всех операций** - для лучшей диагностики
3. **Retry механизм** - повторная попытка запуска при неудаче
4. **Health check перед тестами** - убедиться что сервер действительно готов
