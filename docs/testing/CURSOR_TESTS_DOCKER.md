# Тестирование Cursor с Docker - Подробное логирование

## Обзор

Тесты Cursor (`python test/run_tests.py --cursor`) теперь включают подробное логирование статуса Docker контейнера для лучшей диагностики проблем.

## Что изменилось

### 1. Автоматическая проверка статуса контейнера

При запуске cursor тестов автоматически проверяется:
- Доступность Docker
- Существование контейнера `cursor-agent-life`
- Статус контейнера (running, stopped, restarting)
- Время запуска контейнера
- Ошибки контейнера (если есть)

### 2. Проверка до и после каждого теста

Для каждого cursor теста:
- **Перед тестом**: Выводится текущий статус контейнера
- **После теста**: Проверяется статус контейнера и выводятся логи при проблемах

### 3. Подробные логи при ошибках

Если тест завершается с ошибкой:
- Автоматически выводятся последние 30 строк логов контейнера
- Показывается статус контейнера
- Выводятся ошибки контейнера (если есть)

## Пример вывода

```
================================================================================
КАТЕГОРИЯ: Cursor Integration
================================================================================
[INFO] Описание: Тестирование интеграции с Cursor IDE
[INFO] Тестов в категории: 4

[INFO] Проверка Docker окружения для Cursor тестов...
[OK] Docker контейнер cursor-agent-life запущен и готов к работе

────────────────────────────────────────────────────────────────────────────────
Тест: Реальное выполнение через Cursor CLI
────────────────────────────────────────────────────────────────────────────────
[INFO] Файл: test_real_cursor_cli.py
[INFO] Таймаут: 600s
[INFO] Проверка Docker контейнера перед тестом...
[INFO] Статус контейнера cursor-agent-life:
[OK] Статус: running (запущен)
[INFO] Запущен: 2026-01-18T10:30:15

... (выполнение теста) ...

[INFO] Проверка Docker контейнера после теста...
[OK] Контейнер активен (статус: running)
[OK] Тест пройден за 45.23s
```

## Важно: Контейнер остается активным

**Это нормальное поведение!** 

Docker контейнер `cursor-agent-life` настроен на постоянную работу через команду:
```yaml
command: ["-c", "while true; do sleep 3600; done"]
```

Контейнер должен оставаться активным после выполнения команд. Это позволяет:
- Быстро выполнять последующие команды без перезапуска
- Сохранять состояние между командами
- Избежать задержек на запуск контейнера

## Диагностика проблем

### Контейнер не запускается

Если контейнер не запускается автоматически:

1. Проверьте Docker:
   ```bash
   docker --version
   docker ps
   ```

2. Проверьте логи:
   ```bash
   docker logs cursor-agent-life --tail 50
   ```

3. Попробуйте запустить вручную:
   ```bash
   docker compose -f docker/docker-compose.agent.yml up -d
   ```

### Контейнер постоянно перезапускается

Если контейнер в состоянии `restarting`:

1. Проверьте логи:
   ```bash
   docker logs cursor-agent-life
   ```

2. Остановите и удалите проблемный контейнер:
   ```bash
   docker stop cursor-agent-life
   docker rm cursor-agent-life
   ```

3. Пересоздайте контейнер:
   ```bash
   docker compose -f docker/docker-compose.agent.yml up -d
   ```

### Контейнер не активен после выполнения

Если контейнер остановился после выполнения команды:

1. Проверьте логи на ошибки:
   ```bash
   docker logs cursor-agent-life --tail 100
   ```

2. Проверьте статус:
   ```bash
   docker inspect cursor-agent-life --format "{{json .State}}"
   ```

3. Перезапустите контейнер:
   ```bash
   docker restart cursor-agent-life
   ```

## Вспомогательные функции

Создан модуль `test/docker_utils.py` с функциями для работы с Docker:

```python
from test.docker_utils import (
    check_docker_container_status,
    get_docker_container_logs,
    print_docker_container_info
)

# Проверка статуса
status = check_docker_container_status("cursor-agent-life")
print(f"Контейнер запущен: {status['running']}")

# Получение логов
logs = get_docker_container_logs("cursor-agent-life", lines=50)

# Вывод информации
print_docker_container_info("cursor-agent-life")
```

## Автоматизация

Все проверки выполняются автоматически. Вам не нужно:
- Вручную проверять статус контейнера
- Запускать контейнер перед тестами
- Просматривать логи вручную (они выводятся при ошибках)

Просто запускайте тесты:
```bash
python test/run_tests.py --cursor
```

Все необходимые проверки и диагностика выполняются автоматически!
