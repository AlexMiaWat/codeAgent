# Руководство по тестированию Code Agent

**Дата обновления:** 2026-01-19  
**Версия:** После всех улучшений

---

## Быстрый старт

### Комплексное тестирование

```bash
# Запуск всех комплексных тестов
python test/run_comprehensive_tests.py

# Или отдельно
python test/test_comprehensive_validation.py
```

### Тестирование реального сервера

```bash
# Запуск теста реального сервера (требует запущенного сервера)
python test/test_real_server_integration.py
```

---

## Типы тестов

### 1. Комплексное тестирование валидации

**Файл:** `test/test_comprehensive_validation.py`

**Проверяет:**
- ✅ Валидацию конфигурации при старте
- ✅ Обработку ошибок
- ✅ Безопасность (валидация путей, проверка прав доступа)
- ✅ Валидацию YAML схемы
- ✅ Улучшенное определение формата TODO
- ✅ Работу с реальными целевыми проектами

**Результаты:**
- Пройдено: 21 тест
- Провалено: 0 тестов
- Предупреждений: 2

### 2. Тестирование реального сервера

**Файл:** `test/test_real_server_integration.py`

**Проверяет:**
- Запуск реального сервера
- Работу HTTP API endpoints
- Интеграцию со всеми компонентами

**Требования:**
- Сервер должен быть запущен или будет запущен автоматически
- Доступ к целевому проекту (PROJECT_DIR)

---

## Структура тестов

### Комплексное тестирование (`test_comprehensive_validation.py`)

#### ТЕСТ 1: Валидация конфигурации
- Загрузка валидной конфигурации
- Валидация схемы YAML
- Проверка обязательных полей

#### ТЕСТ 2: Валидация путей и безопасность
- Проверка валидации project_dir
- Защита от path traversal
- Проверка валидации docs_dir

#### ТЕСТ 3: Проверка прав доступа к файлам
- Права на чтение project_dir
- Права на запись project_dir
- Работа StatusManager

#### ТЕСТ 4: Определение формата TODO
- Определение формата Markdown
- Определение формата YAML
- Определение формата TXT
- Загрузка TODO из реального проекта

#### ТЕСТ 5: Утилиты безопасности
- Санитизация API ключей
- Санитизация строк с API ключами

#### ТЕСТ 6: Инициализация сервера
- Создание сервера с валидацией
- Проверка валидации конфигурации
- Проверка инициализации менеджеров

#### ТЕСТ 7: Обработка ошибок
- Обработка несуществующего файла конфигурации
- Обработка невалидного YAML
- Обработка отсутствующего PROJECT_DIR

#### ТЕСТ 8: Ограничения размера файлов
- Проверка ограничения размера TODO файла
- Проверка чтения файла в пределах лимита

---

## Запуск тестов

### Все тесты

```bash
# Из корня проекта
python test/run_comprehensive_tests.py
```

### Отдельные тесты

```bash
# Комплексное тестирование
python test/test_comprehensive_validation.py

# Тест реального сервера
python test/test_real_server_integration.py
```

### Через pytest

```bash
# Все тесты
pytest test/ -v

# Только комплексное тестирование
pytest test/test_comprehensive_validation.py -v

# С покрытием
pytest test/ --cov=src --cov-report=html
```

---

## Результаты тестирования

### Последний запуск (2026-01-19)

**Комплексное тестирование:**
- ✅ Пройдено: 21 тест
- ❌ Провалено: 0 тестов
- ⚠️ Предупреждений: 2

**Детали:**
- Все критические функции работают корректно
- Валидация конфигурации работает
- Безопасность реализована правильно
- Определение формата TODO работает со всеми форматами
- Обработка ошибок корректна

**Предупреждения:**
1. Санитизация строк с API ключами - требуется доработка
2. Тестирование отсутствия PROJECT_DIR - требует изоляции

---

## Требования для тестирования

### Обязательные
- Python 3.8+
- Установленные зависимости из `requirements-test.txt`
- Настроенный `.env` файл с `PROJECT_DIR`
- Доступ к целевому проекту

### Опциональные
- Запущенный Docker (для тестов Cursor CLI)
- Настроенные API ключи (для тестов LLM)

---

## Интерпретация результатов

### ✅ Успешное выполнение
- Все тесты пройдены
- Нет критических ошибок
- Проект готов к использованию

### ⚠️ Предупреждения
- Некоторые функции работают, но требуют доработки
- Не критично для работы системы
- Рекомендуется исправить в будущем

### ❌ Ошибки
- Критические проблемы
- Требуют немедленного исправления
- Система может работать некорректно

---

## Отчеты

Полный отчет о тестировании: [COMPREHENSIVE_TEST_REPORT.md](COMPREHENSIVE_TEST_REPORT.md)

---

## Поддержка

При возникновении проблем:
1. Проверьте настройки в `.env`
2. Убедитесь, что PROJECT_DIR указан правильно
3. Проверьте права доступа к директориям
4. См. логи в `logs/code_agent.log`
