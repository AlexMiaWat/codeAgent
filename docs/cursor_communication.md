# Взаимодействие между Code Agent и Cursor Agent

## Обзор: Правильный контакт через репорты

Ключевой момент взаимодействия между Code Agent и Cursor Agent - это **правильный контакт через файлы-репорты**. Cursor содержит мощные модели, которые понимают контекст с полуслова и могут подробно протоколировать работу, а Code Agent должен **правильно дожидаться выполнения** через механизм репортов.

## Мощные модели Cursor

### Очень умные модели последнего поколения

Cursor IDE использует **очень умные языковые модели последнего поколения**:

- **GPT-4 / GPT-4 Turbo** - одна из самых мощных моделей
- **Claude Opus** - продвинутая модель от Anthropic
- **Claude Sonnet** - мощная модель для сложных задач
- И другие топовые модели

### Возможности моделей Cursor

Эти модели обладают следующими способностями:

✅ **Понимание контекста с полуслова**
- Не требуют детальных инструкций
- Понимают намерения из кратких указаний
- Работают с неполной информацией

✅ **Deep Thinking**
- Глубокий анализ архитектуры проекта
- Сложные рассуждения о реализации
- Принятие архитектурных решений

✅ **Подробное протоколирование**
- Создают детальные отчеты с полным контекстом
- Документируют каждый шаг выполнения
- Описывают принятые решения и их обоснование

✅ **Интеллектуальная работа**
- Генерация сложного кода
- Рефакторинг и оптимизация
- Анализ документации проекта
- Создание тестов и проведение ревью

## Механизм взаимодействия через репорты

### Принцип работы

```
Code Agent                     Cursor Agent
    |                              |
    |── Инструкция ───────────────>|
    |                              |
    |                              | [Выполнение работы]
    |                              | [Создание репорта]
    |                              |
    |<─── Файл-репорт ─────────────|
    |                              |
    | [Проверка репорта]           |
    | [Контрольная фраза?]         |
    |                              |
    |── Следующая инструкция ─────>|
```

### Формат репортов

Cursor Agent создает файлы-репорты в определенных местах:

```
docs/results/
├── current_plan_{task_id}.md      # План выполнения задачи
├── last_result.md                  # Последний результат работы
├── plan_result_{task_id}.md       # Результаты выполнения плана
├── test_{task_id}.md              # Результаты тестирования
└── test_full_{task_id}.md         # Результаты полного тестирования

docs/reviews/
└── skeptic_{task_id}_{date}.md    # Ревью от Скептика
```

### Структура репорта от Cursor

Каждый репорт должен содержать:

```markdown
# Отчет о выполнении задачи

## Выполненные действия

1. [Описание действия 1]
   - Детали выполнения
   - Результаты

2. [Описание действия 2]
   - Детали выполнения
   - Результаты

## Принятые решения

- Решение 1: [Описание] - [Обоснование]
- Решение 2: [Описание] - [Обоснование]

## Проблемы и их решение

- Проблема 1: [Описание] - Решение: [Решение]

## Следующие шаги

- [Описание следующих шагов]

---

[Контрольная фраза для синхронизации]
```

## Процесс ожидания выполнения от Code Agent

### Критически важно: Правильное ожидание

Code Agent **должен правильно дожидаться выполнения работы** Cursor через механизм репортов.

### Алгоритм ожидания

```python
def wait_for_cursor_completion(report_file: Path, timeout: int = 300):
    """
    Code Agent дожидается выполнения работы Cursor
    
    Алгоритм:
    1. Проверяет наличие файла-репорта через интервалы
    2. Если файл создан - читает его
    3. Проверяет наличие контрольной фразы
    4. Если контрольная фраза найдена - работа завершена
    5. Если таймаут истек - проверяет состояние Cursor
    """
    start_time = time.time()
    check_interval = 10  # Проверка каждые 10 секунд
    
    while True:
        elapsed = time.time() - start_time
        
        # Проверка таймаута
        if elapsed > timeout:
            # Проверяем состояние Cursor через интерфейс
            cursor_status = check_cursor_status()
            if cursor_status == "working":
                # Cursor все еще работает, увеличиваем таймаут
                timeout += 60
                continue
            else:
                # Проблема - файл не создан
                log_warning(f"Репорт не создан за {timeout} секунд")
                return False
        
        # Проверка наличия файла
        if report_file.exists():
            content = read_file(report_file)
            
            # Проверка контрольной фразы
            if check_control_phrase(content):
                log_info("Работа Cursor завершена")
                return True
            else:
                # Файл создан, но работа еще не завершена
                log_debug("Файл создан, ожидаем контрольную фразу")
        
        # Ожидание перед следующей проверкой
        time.sleep(check_interval)
```

### Контрольные фразы для синхронизации

Cursor Agent должен добавлять контрольные фразы в конце отчетов:

| Контрольная фраза | Когда используется |
|-------------------|-------------------|
| `"Отчет завершен!"` | Обычные отчеты о выполнении |
| `"Тестирование завершено!"` | Отчеты о тестировании |
| `"Отчет готов!"` | Ревью от Скептика |
| `"План готов!"` | Планы выполнения |
| `"Коммит выполнен!"` | Подтверждение коммита |

Code Agent проверяет наличие этих фраз перед переходом к следующему шагу.

## Пример правильного взаимодействия

### Инструкция 1: Создание плана

**Code Agent отправляет:**
```
Переходим к выполнению задачи "5. Создание клиентского слоя через web front"

Изучи связанную документацию по проекту.
Создай план выполнения текущей задачи в файле docs/results/current_plan_5.1.md
Создай краткий отчет в docs/results/last_result.md
В конце отчета напиши "Отчет завершен!"
```

**Code Agent затем:**
1. Ждет создания файла `docs/results/last_result.md`
   - Проверяет каждые 10 секунд
   - Максимальное ожидание: 5 минут (настраивается)

2. Когда файл создан:
   - Читает содержимое
   - Проверяет наличие фразы "Отчет завершен!"
   - Если фраза найдена → переходит к следующему шагу
   - Если не найдена → продолжает ждать

**Cursor Agent выполняет:**
- Изучает документацию проекта (понимает контекст с полуслова)
- Создает детальный план в `current_plan_5.1.md`
- Создает отчет в `last_result.md` с описанием проделанной работы
- Добавляет фразу "Отчет завершен!" в конце

### Инструкция 2: Выполнение плана

**Code Agent:**
1. Читает план из `docs/results/current_plan_5.1.md`
2. Разбивает план на пункты
3. Для каждого пункта:
   - Отправляет инструкцию Cursor
   - **Ждет обновления файла `plan_result_5.1.md`**
   - Проверяет контрольную фразу
   - Переходит к следующему пункту

**Cursor Agent:**
- Выполняет каждый пункт плана
- Подробно документирует выполнение в `plan_result_5.1.md`
- Понимает контекст из предыдущих шагов
- Добавляет контрольную фразу после каждого пункта

## Обработка ошибок и проблем

### Если файл-репорт не создан

**Code Agent должен:**

1. **Проверить состояние Cursor** (через интерфейс):
   - Скриншот окна Cursor
   - Проверка активности агента
   - Анализ состояния интерфейса

2. **Если Cursor все еще работает:**
   - Увеличить таймаут ожидания
   - Продолжить проверку через интервалы
   - Зафиксировать в протоколе: "Ожидание работы Cursor..."

3. **Если Cursor не работает:**
   - Зафиксировать проблему в `codeAgentProjectStatus.md`
   - Отправить уведомление (если настроено)
   - Решить: пропустить задачу или повторить инструкцию

### Если контрольная фраза не найдена

**Code Agent должен:**

1. **Проверить содержимое файла:**
   - Файл существует, но контрольная фраза отсутствует
   - Возможно, работа еще не завершена

2. **Продолжить ожидание:**
   - Проверить через интервал времени
   - Cursor может еще дописывать отчет

3. **Если после таймаута фраза не появилась:**
   - Зафиксировать проблему в протоколе
   - Возможно, попросить Cursor завершить отчет

## Конфигурация ожидания

Настройки ожидания в `config/config.yaml`:

```yaml
cursor:
  # Интервал проверки файлов-репортов (секунды)
  report_check_interval: 10
  
  # Таймаут ожидания создания файла (секунды)
  file_creation_timeout: 300  # 5 минут
  
  # Таймаут ожидания контрольной фразы после создания файла (секунды)
  control_phrase_timeout: 120  # 2 минуты
  
  # Максимальное количество попыток проверки
  max_check_attempts: 30
  
  # Контрольные фразы для синхронизации
  control_phrases:
    - "Отчет завершен!"
    - "Тестирование завершено!"
    - "Отчет готов!"
    - "План готов!"
    - "Коммит выполнен!"
```

## Лучшие практики

### Для Code Agent:

✅ **Всегда дожидайтесь файлов-репортов**
- Не переходите к следующему шагу без проверки репорта
- Проверяйте контрольные фразы

✅ **Используйте правильные таймауты**
- Не слишком короткие (Cursor может выполнять сложную работу)
- Не слишком длинные (чтобы не ждать зависший процесс)

✅ **Правильно обрабатывайте ожидание**
- Проверяйте состояние Cursor при таймаутах
- Фиксируйте проблемы в протоколе

### Для Cursor Agent (инструкции):

✅ **Всегда создавайте репорты**
- Каждое выполнение должно заканчиваться репортом
- Репорты должны быть в указанных файлах

✅ **Добавляйте контрольные фразы**
- Обязательно в конце каждого репорта
- Используйте правильную фразу для типа отчета

✅ **Подробно документируйте работу**
- Cursor может создать детальные отчеты - используйте эту возможность
- Опишите выполненные действия, принятые решения, проблемы

## Заключение

Правильное взаимодействие между Code Agent и Cursor Agent основано на:

1. **Мощные модели Cursor** - понимают контекст с полуслова, могут подробно протоколировать
2. **Механизм репортов** - файлы-репорты как канал связи
3. **Правильное ожидание** - Code Agent должен дожидаться выполнения через проверку репортов
4. **Контрольные фразы** - для синхронизации завершения работы

Это обеспечивает надежную работу всей системы координации задач.
