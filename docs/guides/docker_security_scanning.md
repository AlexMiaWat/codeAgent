# Руководство по сканированию безопасности Docker образов с Trivy

**Дата:** 2026-01-23
**Статус:** ✅ Реализовано

## Обзор

Для обеспечения безопасности Docker образов, используемых в проекте, внедрен процесс сканирования уязвимостей с помощью инструмента [Trivy](https://github.com/aquasec/trivy). Trivy - это комплексный сканер уязвимостей для контейнеров и других артефактов, который помогает выявлять известные уязвимости (CVE) в зависимостях операционных систем, языковых пакетах и конфигурациях.

## Dockerfile для сканирования безопасности

Файл `docker/Dockerfile.security` содержит конфигурацию для запуска Trivy в изолированном окружении. Он использует официальный образ `aquasec/trivy` и настраивает его для сканирования Docker образов.

### `docker/Dockerfile.security`

```dockerfile
# Dockerfile.security - Пример для демонстрации сканирования безопасности с Trivy

# Используем базовый образ Trivy для сканирования
# Это не образ для сборки, а образ для запуска сканера
FROM aquasec/trivy:latest

# Устанавливаем необходимые инструменты для доступа к Docker демону, если требуется
# В реальном CI/CD пайплайне, Trivy будет запускаться как отдельный шаг,
# имеющий доступ к Docker сокету или уже собранным образам.
# Здесь мы просто демонстрируем его возможности.

# Entrypoint для запуска сканирования.
# Ожидается, что имя образа для сканирования будет передано как аргумент.
ENTRYPOINT ["trivy", "image", "--severity", "HIGH,CRITICAL", "--format", "table", "--output", "/tmp/trivy-results.txt"]
```

## Использование для сканирования образа

Для сканирования Docker образа (например, `cursor-agent:latest`), вы можете выполнить следующую команду:

```bash
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
           dockerfile.security cursor-agent:latest
```

**Примечание:**
- `-v /var/run/docker.sock:/var/run/docker.sock`: Монтирование Docker сокета необходимо, чтобы Trivy мог получить доступ к образам на вашей хост-машине.
- `dockerfile.security`: Это имя образа, который был собран из `docker/Dockerfile.security`.
- `cursor-agent:latest`: Имя целевого образа, который вы хотите отсканировать.

## Результаты сканирования

Результаты сканирования будут выведены в консоль и, если настроено в `Dockerfile.security`, сохранены в файл (например, `/tmp/trivy-results.txt` внутри контейнера Trivy). Рекомендуется настроить CI/CD пайплайн для сохранения этих отчетов в артефактах сборки.

## Интеграция в CI/CD

Рекомендуется интегрировать сканирование безопасности с Trivy в ваш CI/CD пайплайн. Это позволит автоматически проверять образы на уязвимости при каждой сборке и предотвращать развертывание небезопасных образов.

Пример шага в GitLab CI/CD или GitHub Actions:

```yaml
# Пример для GitLab CI/CD
security_scan:
  stage: test
  image: aquasec/trivy:latest
  script:
    - trivy image --severity HIGH,CRITICAL --format table --output trivy-results.txt your-docker-registry/your-image:latest
  artifacts:
    paths:
      - trivy-results.txt
    expire_in: 1 week
  allow_failure: true # Разрешить ошибку, но быть в курсе уязвимостей
```

## Следующие шаги

1.  Интегрировать Trivy в CI/CD пайплайн.
2.  Регулярно анализировать отчеты Trivy и устранять выявленные уязвимости.
3.  Рассмотреть использование других инструментов статического анализа безопасности (SAST) и динамического анализа (DAST).
