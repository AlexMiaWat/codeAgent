# Отказоустойчивая работа Cursor CLI с автоматическим fallback

**Дата создания:** 2026-01-19  
**Статус:** ✅ Реализовано

## Обзор

Реализована система отказоустойчивой работы с Cursor CLI, которая автоматически переключается на резервные модели при проблемах с основной моделью.

## Основные возможности

### 1. Автоматический fallback на резервные модели

Система автоматически:
- Пытается выполнить команду с основной моделью (`auto`)
- При ошибках (billing, timeout, и т.д.) автоматически пробует резервные модели
- Логирует все попытки для диагностики
- Возвращает результат последней успешной попытки

### 2. Настройка через config.yaml

```yaml
cursor:
  cli:
    # Основная модель (работает стабильно)
    model: "auto"
    
    # Резервные модели для fallback
    fallback_models:
      - "grok"  # Первая резервная модель
      # Можно добавить дополнительные:
      # - "gemini-3-flash"
      # - "gemini-3-pro"
    
    # Настройки отказоустойчивости
    resilience:
      # Включить автоматический fallback
      enable_fallback: true
      # Максимальное количество попыток с разными моделями
      max_fallback_attempts: 3
      # Задержка между попытками (секунды)
      fallback_retry_delay: 2
      # Ошибки, при которых активируется fallback
      fallback_on_errors:
        - "billing_error"      # Неоплаченный счет
        - "timeout"            # Таймаут выполнения
        - "model_unavailable"  # Модель недоступна
        - "unknown_error"     # Неизвестная ошибка (код != 0)
```

## Как это работает

### Последовательность выполнения

1. **Попытка с основной моделью** (`auto`)
   - Выполняется команда с `--model auto`
   - Если успешно → возвращается результат
   - Если ошибка → проверяется, нужен ли fallback

2. **Проверка необходимости fallback**
   - Анализируется тип ошибки
   - Проверяется, включен ли fallback для этого типа ошибки
   - Если да → переход к резервным моделям

3. **Попытки с резервными моделями**
   - Пробуются модели из `fallback_models` по очереди
   - Между попытками задержка `fallback_retry_delay` секунд
   - Максимум `max_fallback_attempts` попыток

4. **Результат**
   - Если хотя бы одна попытка успешна → возвращается успешный результат
   - Если все попытки неудачны → возвращается последняя ошибка

### Типы ошибок, активирующих fallback

1. **billing_error** - Неоплаченный счет
   - Обнаруживается по тексту "unpaid invoice" или "pay your invoice" в stderr
   - Автоматически переключается на резервную модель

2. **timeout** - Таймаут выполнения
   - Обнаруживается по тексту "таймаут" или "timeout" в error_message
   - Автоматически переключается на резервную модель

3. **unknown_error** - Неизвестная ошибка
   - Обнаруживается по коду возврата != 0 и != -1
   - Автоматически переключается на резервную модель

## Использование

### Автоматическое использование

Система работает автоматически при вызове `execute_instruction()`:

```python
# В server.py
result = self.cursor_cli.execute_instruction(
    instruction="Создай файл test.txt",
    task_id="task_123",
    working_dir="/path/to/project",
    timeout=300
)
# Автоматически использует fallback при ошибках
```

### Ручное использование

Можно напрямую вызвать `execute_with_fallback()`:

```python
result = cursor_cli.execute_with_fallback(
    prompt="Создай файл test.txt",
    working_dir="/path/to/project",
    timeout=300
)
```

## Логирование

Система логирует все попытки:

```
INFO: Выполнение с fallback: основная модель 'auto', резервные: ['grok']
INFO: Попытка 1/2 с моделью 'auto'
WARNING: Обнаружена billing error - активируем fallback
INFO: Ожидание 2с перед следующей попыткой...
INFO: Попытка 2/2 с моделью 'grok'
INFO: ✅ Успешно выполнено с резервной моделью 'grok' (попытка 2)
```

## Рекомендации

### Основная модель: `auto`

- ✅ Стабильная работа на всех типах задач
- ✅ Хорошо справляется со сложными задачами
- ✅ Рекомендуется как основная модель

### Резервная модель: `grok`

- ✅ Быстрее на средних и сложных задачах (на 40-52%)
- ✅ Работает без billing errors
- ✅ Отличный выбор для fallback

### Добавление дополнительных резервных моделей

Можно добавить несколько резервных моделей:

```yaml
fallback_models:
  - "grok"           # Первая резервная (быстрая)
  - "gemini-3-flash" # Вторая резервная (дешевая)
  - "gemini-3-pro"   # Третья резервная (средняя)
```

Система будет пробовать их по очереди до успешного выполнения или исчерпания попыток.

## Тестирование

Результаты тестирования P0 моделей:

- **auto**: 3/3 успешно (100%)
- **grok**: 3/3 успешно (100%)
- **Среднее время auto**: 40.81s
- **Среднее время grok**: 26.76s (на 34% быстрее)

Подробные результаты: `test_cursor_cli/P0_TEST_RESULTS.md`

## Связанные файлы

- `config/config.yaml` - конфигурация моделей и fallback
- `src/cursor_cli_interface.py` - реализация fallback логики
- `src/server.py` - использование через execute_instruction()
- `test_cursor_cli/P0_TEST_RESULTS.md` - результаты тестирования
