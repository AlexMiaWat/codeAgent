# Детальное описание рабочего процесса Code Agent

## Обзор процесса

Code Agent работает как **оркестратор задач**, координируя выполнение работы между собой и агентами Cursor. Весь процесс документируется в последовательном протоколе `codeAgentProjectStatus.md`.

## Этап 1: Чтение и анализ задачи

### Действия Code Agent:

1. **Чтение todo-листа**
   - Загружает `todo.txt` из директории проекта
   - Парсит задачи с учетом иерархии (номера, уровни вложенности)
   - Определяет непройденные задачи

2. **Проверка документации** (без чтения!)
   - Проверяет наличие директории `docs/`
   - Проверяет наличие ключевых файлов (если указано в конфиге)
   - **НЕ читает содержимое документации** - это делает Cursor

3. **Анализ задачи через LLM (слабая модель)**
   - Отправляет задачу в LLM для простого понимания контекста
   - LLM анализирует **только текст задачи** простыми действиями:
     * Парсинг текста задачи из todo-листа
     * Определение типа задачи по ключевым словам (простой pattern matching)
     * Выбор шаблона инструкции из конфигурации
   - **НЕ делает deep thinking** или сложный анализ
   - **НЕ анализирует документацию** проекта

### Пример:

```
Задача из todo.txt: "5. Создание клиентского слоя через web front"

Code Agent:
- Прочитал задачу ✓
- Проверил наличие docs/ ✓
- LLM (слабая модель) определил тип задачи по ключевым словам:
  - Найдено: "клиентский слой", "web front"
  - Определен тип: "frontend-development"
  - Выбран шаблон инструкции: "default_frontend_task"
```

**Запись в codeAgentProjectStatus.md:**
```markdown
## [2025-01-26 14:30:00] Задача: 5. Создание клиентского слоя

**Время начала:** 2025-01-26 14:30:00
**Статус:** Начата
**Действие:** Задача прочитана из todo.txt, документация проверена (наличие файлов)
```

---

## Этап 2: Планирование шагов

### Действия Code Agent:

1. **Выбор шаблона инструкций** (НЕ планирование!)
   - LLM (слабая модель) выбирает **предопределенный шаблон** из конфигурации
   - НЕ создает новый план, только выбирает существующий шаблон
   - Определение типа задачи → выбор соответствующего шаблона инструкций
   - Шаблоны описаны в `config/config.yaml` в секции `instructions`

2. **Генерация инструкций для Cursor** (используя шаблон!)
   - LLM **подставляет значения** в предопределенный шаблон инструкции
   - Инструкции описывают **что делать**, а не **как это делать кодом**
   - Архитектурное выполнение остается за Cursor (который использует мощные модели)

### Формат инструкций:

Инструкции из конфигурации `config/config.yaml`:

```yaml
instructions:
  default:
    - instruction_id: 1
      name: "Создание плана"
      for_cursor: true
      template: |
        Переходим к выполнению задачи "{task_name}"
        Изучи связанную документацию по проекту.
        Создай план выполнения текущей задачи в файле 
        docs/results/current_plan_{task_id}.md
        Создай краткий отчет в docs/results/last_result.md
```

---

## Этап 3: Взаимодействие с Cursor

### Важно: Мощные модели Cursor

⚠️ **Cursor IDE использует очень умные языковые модели последнего поколения** (GPT-4, Claude Opus и т.д.), которые:

- ✅ **Понимают контекст с полуслова** - не требуют детальных инструкций
- ✅ **Могут подробно протоколировать работу** - создают детальные отчеты
- ✅ **Выполняют сложные задачи** - генерация кода, рефакторинг, архитектурное планирование

**Поэтому для Cursor не составляет труда:**
- Выполнять задачи от Code Agent по простым инструкциям
- Понимать контекст проекта без детального объяснения
- Создавать подробные отчеты о проделанной работе

**Ключевой момент взаимодействия:** Code Agent должен **правильно дожидаться выполнения работы** Cursor через механизм файлов-репортов.

### Способы взаимодействия (планируются):

#### Вариант 1: Скриншоты (визуальное распознавание)
```
Code Agent → Сделать скриншот окна Cursor
           → Распознать состояние интерфейса (OCR/ML)
           → Определить, работает ли Cursor Agent
           → Определить, можно ли создать новый диалог
```

#### Вариант 2: Управление мышью
```
Code Agent → Получить координаты элементов интерфейса
           → Кликнуть на "New Chat" / "New Dialog"
           → Ввести текст инструкции через клавиатуру
           → Отправить сообщение (Enter)
```

#### Вариант 3: Горячие клавиши
```
Code Agent → Фокус на окно Cursor (Alt+Tab / GetWindowFocus)
           → Горячая клавиша для нового диалога (если есть)
           → Ввод текста через keyboard simulation
           → Enter для отправки
```

#### Вариант 4: Файловая система + API (если доступно)
```
Code Agent → Запись инструкции в специальный файл
           → Cursor читает файл через расширение/plugin
           → Cursor создает диалог и выполняет инструкцию
           → Cursor записывает результат обратно
```

**Текущий статус:** Механизмы взаимодействия находятся в разработке. 
Временное решение: ручное создание диалогов или использование файлов для передачи инструкций.

---

## Этап 4: Выполнение инструкций Cursor

### Цикл выполнения инструкций:

```
FOR каждой инструкции из плана:
  1. Code Agent отправляет инструкцию Cursor
  2. Code Agent ждет выполнения
  3. Code Agent проверяет файлы-репорты
  4. Code Agent анализирует результаты
  5. Если есть ошибки → корректирующие действия
  6. Переход к следующей инструкции
```

### Пример выполнения Инструкции 1:

**Действие Code Agent:**
```
Создать новый диалог с Cursor
Отправить инструкцию: "Переходим к выполнению задачи '5. Создание клиентского слоя...'"
```

**Действие Cursor:**
```
1. Агент Cursor получает инструкцию
2. Изучает документацию проекта (docs/)
3. Создает план в docs/results/current_plan_5.1.md
4. Создает отчет в docs/results/last_result.md
5. В конце отчета: "Отчет завершен!"
```

**Проверка Code Agent:**
```python
# Псевдокод проверки
wait_for_file("docs/results/last_result.md", timeout=300)
content = read_file("docs/results/last_result.md")
if "Отчет завершен!" in content:
    proceed_to_next_instruction()
else:
    check_cursor_status()  # через скриншот или интерфейс
    wait_more()
```

**Запись в codeAgentProjectStatus.md:**
```markdown
### Инструкция 1: Создание плана
**Время:** 2025-01-26 14:30:15
**Действие Code Agent:** Создан новый диалог с Cursor, отправлена инструкция

**Инструкция для Cursor:**
> Переходим к выполнению задачи "5. Создание клиентского слоя через web front"
> Изучи связанную документацию по проекту.
> Создай план выполнения в docs/results/current_plan_5.1.md
> Создай отчет в docs/results/last_result.md

**Ожидание:** Проверка файла docs/results/last_result.md

**Результат от Cursor:**
- ✓ Файл docs/results/current_plan_5.1.md создан
- ✓ Файл docs/results/last_result.md создан
- ✓ Контрольная фраза найдена: "Отчет завершен!"

**Время завершения:** 2025-01-26 14:35:20
**Статус:** Успешно
```

---

## Этап 5: Последовательное выполнение плана

### Действия Code Agent:

1. **Чтение плана от Cursor**
   - Читает `docs/results/current_plan_5.1.md`
   - Парсит структуру плана (список пунктов)
   - Создает последовательность инструкций для каждого пункта

2. **Отправка инструкций по пунктам плана**

**Пример плана от Cursor:**
```markdown
# План выполнения задачи 5.1

1. Создать структуру каталогов для фронтенда
2. Настроить сборщик (webpack/vite)
3. Создать базовые компоненты
4. Интегрировать с бэкенд API
5. Добавить роутинг
```

**Code Agent создает инструкции:**
```
Инструкция 2.1: Выполни пункт 1 плана - создай структуру каталогов
Инструкция 2.2: Выполни пункт 2 плана - настрой сборщик
Инструкция 2.3: Выполни пункт 3 плана - создай базовые компоненты
...
```

**Каждая инструкция:**
- Отправляется Cursor (который понимает контекст с полуслова)
- **Code Agent дожидается выполнения** - проверяет файл-репорт через интервалы
- Cursor выполняет работу и **подробно протоколирует** в `docs/results/plan_result_5.1.md`
- Cursor добавляет контрольную фразу "Отчет завершен!" в конце репорта
- Code Agent проверяет контрольную фразу перед следующим пунктом
- Только после подтверждения Code Agent переходит к следующему пункту

---

## Этап 6: Тестирование

### Процесс тестирования:

**Инструкция Code Agent для Cursor:**
```
Покрой тестами новую функциональность:
- Статические тесты
- Дымовые тесты
- Интеграционные тесты
- Другие необходимые тесты

1. Напиши тесты в src/test/
2. Запусти тесты
3. Отчет в docs/results/test_5.1.md
4. В конце: "Тестирование завершено!"
```

**Cursor выполняет:**
- Создает тесты
- Запускает их
- Формирует отчет с результатами

**Code Agent проверяет:**
- Наличие файла `docs/results/test_5.1.md`
- Контрольную фразу
- Наличие ошибок в отчете

**Если есть ошибки:**
```markdown
### Инструкция 3: Тестирование
**Время:** 2025-01-26 15:00:00
**Результат:** Обнаружены ошибки тестирования
**Ошибки:**
- Тест test_component_a.py: 2 failures
- Тест test_integration.py: 1 failure

**Действие:** Отправлена инструкция Cursor на исправление
**Попытка исправления:** 1/3
```

**После исправления:**
```markdown
**Попытка исправления:** 2/3
**Результат:** Ошибки исправлены
**Финальный статус:** Тестирование завершено успешно
```

---

## Этап 7: Ревью Скептика

### Процесс ревью:

**Code Agent отправляет инструкцию:**
```
Выступи в роли Скептика.

Проанализируй:
- Текущие доработки
- Документацию
- Код

Найди:
- Недоработки
- Отклонения от плана
- Проблемы в коде
- Сомнительный код

Отчет в docs/reviews/skeptic_5.1_18.01.26.md
В конце: "Отчет готов!"
```

**Cursor (Скептик) создает ревью:**
```markdown
# Ревью от Скептика

## Найденные проблемы:

1. В компоненте X отсутствует обработка ошибок
2. Документация не обновлена для нового API
3. Тесты не покрывают edge cases
...

Отчет готов!
```

**Code Agent читает ревью и отправляет архитектору:**
```
Проанализируй ревью Скептика из docs/reviews/skeptic_5.1_18.01.26.md

Составь план исправления проблем и реализуй его.
```

---

## Этап 8: Коммит и отправка

### Процесс коммита:

**Инструкция Code Agent:**
```
Создай коммит с подробным описанием.

Включи все модифицированные файлы.

Отправь коммит в удаленный репозиторий.
```

**Cursor выполняет:**
```bash
git add .
git commit -m "feat: Реализация клиентского слоя (задача 5.1)

- Создана структура каталогов фронтенда
- Настроен сборщик webpack
- Реализованы базовые компоненты
- Добавлена интеграция с API
- Покрыто тестами
- Обновлена документация"
git push origin main
```

**Code Agent фиксирует:**
```markdown
### Инструкция 9: Коммит и отправка
**Время:** 2025-01-26 16:30:00
**Действие:** Отправлена инструкция на создание коммита
**Результат:** Коммит создан и отправлен в удаленный репозиторий
**Коммит ID:** abc123def456
```

---

## Итоговая запись в codeAgentProjectStatus.md

```markdown
## [2025-01-26 14:30:00] Задача: 5. Создание клиентского слоя

**Статус:** ✅ Выполнена
**Время начала:** 2025-01-26 14:30:00
**Время завершения:** 2025-01-26 16:35:00
**Длительность:** 2 часа 5 минут

### Выполненные инструкции:
1. ✅ Создание плана
2. ✅ Выполнение плана (5 пунктов)
3. ✅ Тестирование
4. ✅ Обновление документации
5. ✅ Ревью Скептика
6. ✅ Исправление по ревью
7. ✅ Полное тестирование
8. ✅ Коммит и отправка

**Итоговый результат:**
- План выполнен полностью
- Все тесты пройдены
- Документация обновлена
- Изменения закоммичены

**Коммит:** abc123def456
**Ветка:** main

---

**Задача отмечена как выполненная в todo.txt**
```

---

## Обработка ошибок и исключений

### Типы ошибок:

1. **Ошибка выполнения в Cursor**
   - Code Agent получает сообщение об ошибке
   - Фиксирует в протоколе
   - Отправляет инструкцию на исправление
   - До 3 попыток (настраивается)

2. **Таймаут ожидания**
   - Если Cursor не отвечает в течение таймаута
   - Code Agent проверяет состояние через интерфейс
   - Если Cursor завис - фиксирует и пропускает задачу

3. **Отсутствие файлов-репортов**
   - Если файл не создан после таймаута
   - Code Agent проверяет, работает ли Cursor
   - Решает: ждать дальше или пропустить

4. **Критические ошибки**
   - Если задача не может быть выполнена
   - Code Agent фиксирует это в протоколе
   - Переходит к следующей задаче
   - Администратору отправляется уведомление (если настроено)

---

## Расширенные возможности

### Иерархические планы:

```
План задачи 5.1:
  ├─ 5.1.1: Подзадача A
  │   ├─ 5.1.1.1: Шаг 1
  │   └─ 5.1.1.2: Шаг 2 (если нужно ветвление)
  ├─ 5.1.2: Подзадача B
  └─ 5.1.3: Подзадача C (параллельно с B)
```

Code Agent может:
- Обрабатывать вложенные структуры
- Создавать условные ветвления
- Запускать параллельные ветки
- Объединять результаты

### Условное выполнение:

```
IF тесты провалились:
    → Исправить ошибки
    → Перезапустить тесты
ELSE IF есть ревью Скептика:
    → Исправить замечания
ELSE:
    → Продолжить выполнение
```

---

## Заключение

Code Agent работает как **интеллектуальный координатор**, который:
- Планирует выполнение в рамках todo-листа
- Генерирует инструкции для Cursor (не код!)
- Контролирует выполнение через файлы-репорты
- Ведет детальный протокол всех действий
- Обрабатывает ошибки и исключения
- Обеспечивает непрерывность процесса разработки

Архитектурное выполнение, написание кода, тестирование - все это остается за агентами Cursor, которые получают четкие инструкции от Code Agent.
