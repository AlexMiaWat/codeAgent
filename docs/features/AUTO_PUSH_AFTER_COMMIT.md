# Автоматический Push после Коммита

**Дата создания:** 2026-01-26  
**Версия:** 1.0

---

## Описание

Реализована функциональность автоматической отправки коммитов в удаленный репозиторий после успешного выполнения инструкции 8 (Коммит и отправка) через Cursor CLI.

**Ключевая особенность:** Push выполняется напрямую из сервера Code Agent, без использования Cursor CLI, что обеспечивает более надежную работу.

---

## Как это работает

### Процесс выполнения

1. **Cursor CLI выполняет коммит** (инструкция 8)
   - Cursor создает коммит с описанием выполненной работы
   - Коммит создается локально в целевом проекте

2. **Сервер проверяет успешность коммита**
   - После успешного выполнения инструкции 8
   - Проверяется существование последнего коммита
   - Получается информация о коммите (hash, сообщение)

3. **Проверка разрешений ветки**
   - Определяется текущая ветка
   - Проверяется, разрешена ли эта ветка для автоматического push
   - Если ветка не разрешена - push пропускается (информационное сообщение)

4. **Автоматический push из сервера**
   - Проверяется наличие неотправленных коммитов
   - Выполняется `git push origin <branch>`
   - Результат логируется

### Преимущества

✅ **Надежность**: Push выполняется напрямую из сервера, не зависит от Cursor CLI
✅ **Автоматизация**: Не требует ручного вмешательства
✅ **Логирование**: Все операции логируются для диагностики
✅ **Безопасность**: Проверка успешности коммита перед push
✅ **Контроль веток**: Автоматический push только в разрешенных ветках

---

## Реализация

### Новые файлы

- **`src/git_utils.py`** - Утилиты для работы с Git
  - `execute_git_command()` - Выполнение git команд
  - `get_current_branch()` - Получение текущей ветки
  - `is_branch_allowed_for_auto_push()` - Проверка разрешений ветки для авто-push
  - `get_last_commit_info()` - Информация о последнем коммите
  - `check_commit_exists()` - Проверка существования коммита
  - `check_unpushed_commits()` - Проверка неотправленных коммитов
  - `push_to_remote()` - Отправка в удаленный репозиторий
  - `auto_push_after_commit()` - Автоматический push после коммита (с контролем веток)

### Изменения в существующих файлах

- **`src/server.py`**
  - Добавлен импорт `git_utils`
  - Добавлена логика автоматического push после инструкции 8
  - Логирование результатов push

---

## Использование

### Автоматическое использование

Функциональность работает автоматически при выполнении инструкции 8:

1. Cursor CLI выполняет коммит (как обычно)
2. После успешного выполнения инструкции 8 сервер автоматически:
   - Проверяет наличие коммита
   - Определяет текущую ветку
   - Выполняет push в `origin/<branch>`

### Логирование

Все операции логируются:

```
INFO: Инструкция 8 выполнена успешно - выполняем автоматический push из сервера
INFO: Отправка коммитов в origin/main
INFO: Коммиты успешно отправлены в origin/main
INFO: ✅ Автоматический push выполнен успешно: main -> origin/main
INFO: Коммит: abc123 - feat: Реализация новой функциональности
```

При ошибках:

```
WARNING: ⚠️ Автоматический push не удался: <причина ошибки>
```

### Push пропущен для неразрешенной ветки

```
INFO: Инструкция 8 выполнена успешно - выполняем автоматический push из сервера
INFO: ℹ️ Автоматический push пропущен: ветка 'main' не разрешена для авто-push
INFO: Push пропущен: ветка 'main' не в списке разрешенных
```

---

## Контроль разрешений веток

### Назначение

Функциональность контроля разрешений позволяет ограничивать автоматический push только определенными ветками, обеспечивая безопасность и контроль над автоматическими коммитами.

### Как работает

1. **Определение ветки** - Получается текущая ветка проекта
2. **Проверка разрешений** - Сравнивается с списком разрешенных веток
3. **Принятие решения**:
   - ✅ Ветка разрешена → push выполняется
   - ❌ Ветка не разрешена → push пропускается (информационное сообщение)

### Настройка разрешений

В `config/config.yaml`:

```yaml
git:
  smart_git:
    allowed_branches: ["smart", "develop"]  # Разрешенные ветки
```

### По умолчанию

- Разрешена только ветка `"smart"`
- Это обеспечивает безопасность для основных веток (`main`, `master`)

### Преимущества

✅ **Безопасность** - Защита основных веток от автоматических коммитов  
✅ **Гибкость** - Возможность настройки списка разрешенных веток  
✅ **Прозрачность** - Информационные сообщения о пропуске push

---

## Настройка

### Требования

1. **SSH-ключ настроен** для доступа к удаленному репозиторию
   - См. `docs/guides/GIT_AUTHENTICATION_SETUP.md`

2. **Git настроен** в целевом проекте
   - Remote `origin` должен быть настроен
   - Ветка должна существовать локально

### Параметры конфигурации

#### Основные настройки Git

В `config/config.yaml` в секции `git`:

```yaml
git:
  auto_commit: true  # Автоматические коммиты включены для совместимости
  commit_message_template: |
    feat: {task_name} (задача {task_id})

    {task_description}

    Выполнено через Code Agent
  branch: main
  remote: origin
```

#### Специальные настройки Smart Git

Новые настройки для контроля автоматического push в зависимости от ветки:

```yaml
git:
  # ... основные настройки ...

  # Настройки автоматического push для разных веток
  smart_git:
    # Ветка smart - специальная ветка для автоматических коммитов
    enabled: true
    allowed_branches: ["smart"]  # Только ветка smart разрешена для авто-push
    auto_push_timeout: 60        # Таймаут push в секундах
    remote: origin               # Remote для push
```

### Параметры

- `remote` - Название remote (по умолчанию `"origin"`)
- `timeout` - Таймаут выполнения push (по умолчанию 60 секунд, настраивается через `auto_push_timeout`)
- `allowed_branches` - Список разрешенных веток для автоматического push (по умолчанию `["smart"]`)

---

## Обработка ошибок

### Сценарии

1. **Коммит не был создан**
   - Push не выполняется
   - Логируется предупреждение
   - Задача продолжает выполняться

2. **Нет неотправленных коммитов**
   - Push не выполняется (не требуется)
   - Логируется информационное сообщение
   - Задача продолжает выполняться

3. **Push не удался**
   - Логируется предупреждение с причиной
   - Задача продолжает выполняться (коммит уже создан)
   - Можно выполнить push вручную

4. **Ветка не разрешена для push**
   - Push пропускается
   - Логируется информационное сообщение
   - Задача продолжает выполняться
   - Коммит остается локальным

5. **Ошибка выполнения**
   - Логируется ошибка
   - Задача продолжает выполняться
   - Не прерывает выполнение задачи

### Важно

⚠️ **Push не прерывает выполнение задачи** - даже если push не удался, задача считается выполненной (коммит уже создан).

---

## Примеры использования

### Успешный push

```
[2026-01-26 14:30:00] INFO: Инструкция 8 выполнена успешно - выполняем автоматический push из сервера
[2026-01-26 14:30:01] INFO: Отправка коммитов в origin/main
[2026-01-26 14:30:05] INFO: Коммиты успешно отправлены в origin/main
[2026-01-26 14:30:05] INFO: ✅ Автоматический push выполнен успешно: main -> origin/main
[2026-01-26 14:30:05] INFO: Коммит: abc123 - feat: Реализация новой функциональности
```

### Push не требуется

```
[2026-01-26 14:30:00] INFO: Инструкция 8 выполнена успешно - выполняем автоматический push из сервера
[2026-01-26 14:30:01] INFO: Нет неотправленных коммитов в ветке main
```

### Ошибка push

```
[2026-01-26 14:30:00] INFO: Инструкция 8 выполнена успешно - выполняем автоматический push из сервера
[2026-01-26 14:30:01] WARNING: Не удалось отправить коммиты в origin/main: Permission denied
[2026-01-26 14:30:01] WARNING: ⚠️ Автоматический push не удался: Push не удался: Permission denied
```

---

## Технические детали

### Проверки перед push

1. ✅ Существование последнего коммита
2. ✅ Определение текущей ветки
3. ✅ Проверка разрешений ветки для авто-push
4. ✅ Проверка наличия неотправленных коммитов
5. ✅ Выполнение push

### Безопасность

- Все git команды выполняются с таймаутом
- Ошибки обрабатываются и логируются
- Push не прерывает выполнение задачи

---

## Связанные документы

- `docs/guides/GIT_AUTHENTICATION_SETUP.md` - Настройка SSH для Git
- `config/config.yaml` - Конфигурация инструкций (инструкция 8)

---

## История изменений

### v1.1 (2026-01-22)
- ✅ Добавлен контроль разрешений веток для авто-push
- ✅ Новая функция `is_branch_allowed_for_auto_push()` в `git_utils.py`
- ✅ Настройки `smart_git` в конфигурации
- ✅ Безопасность: только разрешенные ветки допускают авто-push
- ✅ Информационные сообщения для пропущенных push

### v1.0 (2026-01-26)
- ✅ Реализован автоматический push после коммита
- ✅ Создана утилита `git_utils.py`
- ✅ Добавлена интеграция в `server.py`
- ✅ Добавлено логирование результатов
