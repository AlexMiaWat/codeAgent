# Автоматическая генерация TODO листов

## Обзор

Система автоматической генерации TODO листов позволяет Code Agent самостоятельно создавать новые задачи для развития проекта, когда текущий список задач пуст или выполнен.

## Возможности

### 1. Автоматическое определение пустого TODO листа

Когда все задачи выполнены, сервер автоматически определяет это и инициирует процесс генерации новых задач.

### 2. Ограничение количества генераций

Для предотвращения бесконечного цикла генерации, система ограничивает количество автоматических генераций TODO листов за одну сессию (по умолчанию: 5 раз).

### 3. Отслеживание сессий

Все генерации отслеживаются и сохраняются в файле `.codeagent_sessions.json` в директории проекта. Это позволяет:
- Отслеживать историю генераций
- Контролировать лимиты
- Анализировать статистику

### 4. Многоэтапный процесс генерации

Процесс генерации нового TODO листа состоит из нескольких этапов:

#### Этап 1: Архитектурный анализ и создание TODO листа
- Cursor анализирует текущее состояние проекта
- Определяет направления для развития
- Создает новый TODO лист с приоритетными задачами
- Сохраняет в `todo/GENERATED_YYYYMMDD_HHMMSS.md`

#### Этап 2: Создание документации для задач
- Для каждой задачи создается подробная документация
- Документация включает:
  - Техническое описание
  - Архитектурные решения
  - План реализации
  - Потенциальные риски
  - Критерии приемки
- Сохраняется в `docs/planning/task_N_SESSIONID.md`

#### Этап 3: Финализация TODO листа
- Проверка соответствия формату (чекбоксы `- [ ]`)
- Добавление ссылок на документацию
- Сохранение финальной версии в `todo/CURRENT.md`

#### Этап 4: Коммит изменений
- Создание подробного коммита с новым TODO листом
- Включение всей созданной документации
- Отправка в репозиторий

## Конфигурация

### Основные настройки

В `config/config.yaml`:

```yaml
server:
  auto_todo_generation:
    # Включить/выключить автоматическую генерацию
    enabled: true
    
    # Максимальное количество генераций за сессию
    max_generations_per_session: 5
    
    # Директория для сохранения сгенерированных TODO
    output_dir: "todo"
    
    # Файл для отслеживания сессий
    session_tracker_file: ".codeagent_sessions.json"
```

### Инструкции для генерации

Инструкции определены в секции `instructions.empty_todo` конфигурации. Каждая инструкция включает:
- `instruction_id`: Уникальный идентификатор
- `name`: Название этапа
- `template`: Шаблон инструкции для Cursor
- `wait_for_file`: Файл результата для ожидания
- `control_phrase`: Контрольная фраза для подтверждения завершения
- `timeout`: Таймаут выполнения (секунды)

## Использование

### Автоматический режим

При запуске сервера в обычном режиме:

```bash
python main.py
```

Когда все задачи выполнены, сервер автоматически:
1. Определит пустой TODO лист
2. Проверит лимит генераций
3. Запустит процесс генерации нового TODO листа
4. Загрузит новые задачи и продолжит работу

### Отключение автоматической генерации

Чтобы отключить автоматическую генерацию, установите в конфигурации:

```yaml
server:
  auto_todo_generation:
    enabled: false
```

## Формат сгенерированных TODO листов

Все сгенерированные TODO листы соответствуют формату, определенному в `docs/planning/todo_format_requirements.md`:

```markdown
# TODO: Развитие проекта (Генерация 20260118_143022)

> **Создано:** 2026-01-18
> **Сессия:** 20260118_143022
> **Источник:** Автоматическая генерация Code Agent

## Высокий приоритет
- [ ] Задача 1: Улучшение производительности - см. docs/planning/task_1_20260118_143022.md
- [ ] Задача 2: Рефакторинг архитектуры - см. docs/planning/task_2_20260118_143022.md

## Средний приоритет
- [ ] Задача 3: Обновление документации - см. docs/planning/task_3_20260118_143022.md
```

## Отслеживание сессий

### Структура файла `.codeagent_sessions.json`

```json
{
  "sessions": [
    {
      "session_id": "20260118_143022",
      "start_time": "2026-01-18T14:30:22.123456",
      "generation_count": 2,
      "generations": [
        {
          "session_id": "20260118_143022",
          "timestamp": "2026-01-18T14:35:10.123456",
          "todo_file": "todo/GENERATED_20260118_143022.md",
          "task_count": 7,
          "metadata": {
            "date": "20260118",
            "docs_created": 3
          }
        }
      ]
    }
  ],
  "total_generations": 2,
  "last_generation_date": "2026-01-18T14:35:10.123456"
}
```

### API для работы с сессиями

```python
from src.session_tracker import SessionTracker

# Создание трекера
tracker = SessionTracker(project_dir, ".codeagent_sessions.json")

# Проверка возможности генерации
can_generate = tracker.can_generate_todo(max_generations=5)

# Получение статистики
stats = tracker.get_session_statistics()
print(f"Генераций в текущей сессии: {stats['generation_count']}")
print(f"Всего генераций: {stats['total_generations_all_time']}")

# Запись генерации
tracker.record_generation(
    todo_file="todo/GENERATED_20260118.md",
    task_count=7,
    metadata={"custom": "data"}
)
```

## Примеры использования

### Пример 1: Базовая работа

```python
from src.server import CodeAgentServer

# Создание и запуск сервера
server = CodeAgentServer("config/config.yaml")
server.start()

# Сервер автоматически:
# 1. Выполнит все задачи из TODO
# 2. Обнаружит пустой TODO лист
# 3. Сгенерирует новый TODO лист
# 4. Продолжит выполнение новых задач
```

### Пример 2: Ручная генерация

```python
from src.server import CodeAgentServer

server = CodeAgentServer("config/config.yaml")

# Ручной запуск генерации
success = server._generate_new_todo_list()

if success:
    print("Новый TODO лист успешно сгенерирован")
    # Перезагрузка задач
    server.todo_manager = TodoManager(
        server.project_dir,
        todo_format='md'
    )
```

### Пример 3: Проверка лимитов

```python
from src.session_tracker import SessionTracker

tracker = SessionTracker(project_dir)

# Проверка текущего состояния
stats = tracker.get_session_statistics()
current_count = stats['generation_count']
max_allowed = 5

if current_count < max_allowed:
    print(f"Можно сгенерировать еще {max_allowed - current_count} раз")
else:
    print("Достигнут лимит генераций для текущей сессии")
```

## Интеграция с целевым проектом

Все сгенерированные TODO листы и документация сохраняются в целевом проекте:

```
target_project/
├── todo/
│   ├── CURRENT.md                          # Текущий TODO лист
│   ├── GENERATED_20260118_143022.md        # Сгенерированный TODO
│   └── GENERATED_20260118_150045.md        # Еще одна генерация
├── docs/
│   ├── planning/
│   │   ├── task_1_20260118_143022.md      # Документация задачи 1
│   │   ├── task_2_20260118_143022.md      # Документация задачи 2
│   │   └── task_3_20260118_143022.md      # Документация задачи 3
│   └── results/
│       ├── todo_generation_20260118_143022.md
│       └── todo_finalized_20260118_143022.md
└── .codeagent_sessions.json                # Трекинг сессий
```

## Лучшие практики

### 1. Настройка лимитов

Рекомендуется устанавливать разумные лимиты генераций:
- Для небольших проектов: 3-5 генераций за сессию
- Для крупных проектов: 5-10 генераций за сессию

### 2. Ревью сгенерированных TODO

После автоматической генерации рекомендуется:
- Проверить соответствие задач целям проекта
- Скорректировать приоритеты при необходимости
- Дополнить задачи специфичными требованиями

### 3. Мониторинг генераций

Регулярно проверяйте файл `.codeagent_sessions.json` для:
- Анализа частоты генераций
- Выявления паттернов
- Оптимизации настроек

### 4. Резервное копирование

Сохраняйте резервные копии сгенерированных TODO листов:
```bash
cp todo/CURRENT.md todo/backups/CURRENT_$(date +%Y%m%d).md
```

## Устранение неполадок

### Проблема: Генерация не запускается

**Решение:**
1. Проверьте настройку `enabled: true` в конфигурации
2. Убедитесь, что не достигнут лимит генераций
3. Проверьте логи: `logs/code_agent.log`

### Проблема: Достигнут лимит генераций

**Решение:**
1. Увеличьте `max_generations_per_session` в конфигурации
2. Или перезапустите сервер (новая сессия)
3. Или сбросьте счетчик вручную:
```python
tracker = SessionTracker(project_dir)
tracker.reset_session_counter()
```

### Проблема: Сгенерированные задачи не загружаются

**Решение:**
1. Проверьте формат TODO файла (должны быть чекбоксы `- [ ]`)
2. Убедитесь, что файл `todo/CURRENT.md` существует
3. Проверьте права доступа к файлам

## См. также

- [Формат TODO листов](../planning/todo_format_requirements.md)
- [Конфигурация сервера](../configuration/server_config.md)
- [Инструкции для Cursor](../configuration/cursor_instructions.md)
