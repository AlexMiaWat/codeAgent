# План выполнения задачи: Выделить `ServerCore` для базового цикла выполнения

## Цель задачи
Выделить базовый цикл выполнения из монолитного класса `CodeAgentServer` в отдельный компонент `ServerCore`, обеспечивая лучшее разделение ответственностей и архитектурную чистоту.

## Текущая ситуация
- Класс `CodeAgentServer` содержит более 4500 строк кода
- Весь цикл выполнения, включая логику обработки задач, ревизии и генерации TODO, находится внутри одного класса
- Нарушение принципа единственной ответственности (SRP)

## План выполнения

### 1. Анализ требований к ServerCore ✅
**Цель:** Определить границы ответственности ServerCore
- Базовый цикл выполнения задач
- Управление состоянием итераций
- Синхронизация с checkpoint системой
- Обработка сценариев "нет задач" (ревизия, генерация TODO)
- Возврат результатов выполнения для дальнейшей обработки

### 2. Создание директории src/core/ ✅
**Цель:** Организовать структуру согласно проектным правилам
- Создать директорию `src/core/`
- Подготовить место для компонентов ядра системы

### 3. Проектирование интерфейса ServerCore
**Цель:** Определить контракт взаимодействия с внешними компонентами
- Определить публичные методы: `execute_iteration()`, `handle_no_tasks_scenario()`
- Определить зависимости: TodoManager, CheckpointManager, StatusManager
- Спроектировать обработку исключений и состояний

### 4. Выделение базовой логики цикла выполнения
**Цель:** Извлечь логику из `CodeAgentServer.run_iteration()`
- Логика получения и фильтрации задач
- Цикл выполнения задач с проверками остановки
- Логика ревизии проекта при отсутствии задач
- Логика генерации нового TODO

### 5. Реализация класса ServerCore
**Цель:** Создать новый компонент с выделенной логикой
- Реализовать класс `ServerCore` в `src/core/server_core.py`
- Интегрировать все необходимые зависимости
- Обеспечить обратную совместимость интерфейса

### 6. Интеграция ServerCore в CodeAgentServer
**Цель:** Заменить внутреннюю логику на использование ServerCore
- Модифицировать `CodeAgentServer.run_iteration()` для делегирования
- Сохранить существующую логику управления сервером (HTTP, перезапуски)
- Обеспечить передачу всех необходимых зависимостей

### 7. Обновление импортов и зависимостей
**Цель:** Корректно настроить связи между компонентами
- Добавить импорт ServerCore в server.py
- Обновить конструктор CodeAgentServer для создания ServerCore
- Проверить все зависимости и ссылки

### 8. Тестирование интеграции
**Цель:** Убедиться в корректности работы после рефакторинга
- Запустить существующие тесты
- Проверить функциональность цикла выполнения
- Валидировать сценарии edge cases (остановка, перезапуск, ошибки)

## Критерии успеха
- Код компилируется без ошибок
- Все существующие тесты проходят
- Функциональность цикла выполнения не изменилась
- Архитектура стала более модульной
- Код стал более читаемым и поддерживаемым

## Риски и mitigation
- **Риск:** Нарушение существующей логики
  - **Митigation:** Тщательное тестирование, поэтапное внедрение
- **Риск:** Проблемы с зависимостями
  - **Митigation:** Анализ всех ссылок перед изменениями
- **Риск:** Регрессии в сложных сценариях
  - **Митigation:** Запуск полного набора интеграционных тестов

## Ожидаемый результат
- Разделение монолитного класса на специализированные компоненты
- Улучшение поддерживаемости и расширяемости кода
- Подготовка архитектуры для дальнейшей декомпозиции (TaskOrchestrator, ConfigurationManager и т.д.)