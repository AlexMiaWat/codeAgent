# InstructionProcessor - Обработчик инструкций

## Обзор

Класс `InstructionProcessor` отвечает за централизованную обработку инструкций и промптов, которые используются для взаимодействия с Code Agent и LLM. Он определяет тип задачи, получает соответствующие шаблоны инструкций из конфигурации и форматирует их для дальнейшего выполнения.

**Расположение:** `src/core/instruction_processor.py`

## Назначение

- **Определение типа задачи:** Анализирует текст задачи для присвоения ей категории (e.g., test, documentation, refactoring, development, default).
- **Управление шаблонами инструкций:** Извлекает предопределенные шаблоны инструкций из конфигурации на основе типа задачи.
- **Форматирование промптов:** Подставляет динамические данные (например, имя задачи, ID, дата) в шаблоны инструкций для создания финального промпта для LLM.
- **Загрузка контекста проекта:** Способен загружать документацию проекта для предоставления LLM релевантного контекста.

## Инициализация

`InstructionProcessor` инициализируется словарем конфигурации и путем к директории проекта:

```python
processor = InstructionProcessor(config, project_dir)
```

- `config`: Словарь конфигурации, содержащий секцию `instructions` с шаблонами.
- `project_dir`: Объект `pathlib.Path`, указывающий на корневую директорию проекта.

## Основные методы

### `_determine_task_type(self, todo_item: TodoItem) -> str`

Определяет тип задачи на основе ключевых слов в тексте `todo_item`.

**Аргументы:**
- `todo_item`: Объект `TodoItem`, содержащий описание задачи.

**Возвращает:**
- Строка, представляющая тип задачи (например, `'test'`, `'documentation'`, `'refactoring'`, `'development'`, `'default'`).

### `_get_instruction_template(self, task_type: str, instruction_id: int = 1) -> Optional[Dict[str, Any]]`

Получает один шаблон инструкции из конфигурации по типу задачи и опциональному ID инструкции. Если `instruction_id` не указан, возвращает первую доступную инструкцию для совместимости.

**Аргументы:**
- `task_type`: Тип задачи.
- `instruction_id`: ID инструкции (1-8 для последовательного выполнения). По умолчанию `1`.

**Возвращает:**
- Словарь с шаблоном инструкции или `None`, если шаблон не найден.

### `_get_all_instruction_templates(self, task_type: str) -> List[Dict[str, Any]]`

Получает все шаблоны инструкций для заданного типа задачи, отсортированные по `instruction_id`.

**Аргументы:**
- `task_type`: Тип задачи.

**Возвращает:**
- Список словарей, каждый из которых представляет шаблон инструкции.

### `_format_instruction(self, template: Dict[str, Any], todo_item: TodoItem, task_id: str, instruction_num: int = 1) -> str`

Форматирует шаблон инструкции, подставляя в него значения из объекта `todo_item`, `task_id` и номера инструкции.

**Аргументы:**
- `template`: Словарь с шаблоном инструкции.
- `todo_item`: Объект `TodoItem`.
- `task_id`: Идентификатор текущей задачи.
- `instruction_num`: Номер инструкции в последовательности. По умолчанию `1`.

**Возвращает:**
- Отформатированная строка инструкции, готовая для использования LLM.

### `_load_documentation(self) -> str`

Загружает содержимое документации проекта из директории `docs/`. Фильтрует файлы по расширению и размеру, как указано в конфигурации.

**Возвращает:**
- Строка, содержащая объединенное содержимое всех релевантных файлов документации.

### `_create_task_execution_prompt(self, todo_item: TodoItem, task_type: str) -> str`

Создает полный промпт для выполнения задачи через LLM, включая контекст проекта, тип задачи, описание и требования к выполнению.

**Аргументы:**
- `todo_item`: Объект `TodoItem`.
- `task_type`: Тип задачи.

**Возвращает:**
- Сформированный промпт для LLM.

## Интеграция

`InstructionProcessor` является ключевым компонентом для `ITaskProcessor`, предоставляя ему логику для подготовки инструкций и промптов перед обращением к LLM. Это позволяет отделить логику формирования промптов от общей логики управления задачами.