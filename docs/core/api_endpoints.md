# API Endpoints Code Agent Server

**Версия:** 2.1  
**Дата обновления:** 2026-01-26  
**Статус:** ✅ Полностью соответствует реализации в `src/server.py`

Сервер предоставляет HTTP API для мониторинга и управления на порту 3456 (по умолчанию). API доступен сразу после запуска сервера и работает в фоновом режиме.

## Быстрый старт

```bash
# Запуск сервера
python main.py

# Проверка доступности API
curl http://127.0.0.1:3456/health

# Получение статуса
curl http://127.0.0.1:3456/status
```

## Endpoints

Всего доступно **5 endpoints**:

1. `GET /` - Главная страница с общей информацией
2. `GET /status` - Подробный статус сервера и задач
3. `GET /health` - Health check для мониторинга
4. `POST /stop` - Немедленная остановка сервера
5. `POST /restart` - Перезапуск сервера после текущей итерации

---

### 1. GET /health
Проверка работоспособности сервера.

**Ответ:**
```json
{
  "status": "healthy",
  "timestamp": "2026-01-19T09:00:00"
}
```

### 2. GET /
Главная страница с общей информацией о сервере.

**Описание:** Возвращает краткую информацию о состоянии сервера, статистику задач и настройки.

**Ответ:**
```json
{
  "status": "running",
  "port": 3456,
  "session_id": "20260119_090000",
  "iteration": 5,
  "statistics": {
    "total_tasks": 10,
    "completed": 5,
    "failed": 2,
    "in_progress": 1,
    "pending": 2
  },
  "project_dir": "D:\\Space\\life",
  "cursor_cli_available": true,
  "auto_todo_enabled": true
}
```

**Поля:**
- `status` - статус сервера: `"running"` или `"stopped"`
- `port` - порт HTTP сервера
- `session_id` - идентификатор текущей сессии (формат: `YYYYMMDD_HHMMSS`)
- `iteration` - количество выполненных итераций
- `statistics` - статистика задач из checkpoint:
  - `total_tasks` - общее количество задач
  - `completed` - выполнено задач
  - `failed` - задач с ошибками
  - `in_progress` - задач в процессе
  - `pending` - ожидающих выполнения
- `project_dir` - путь к директории проекта
- `cursor_cli_available` - доступен ли Cursor CLI интерфейс
- `auto_todo_enabled` - включена ли автоматическая генерация TODO

### 3. GET /status
**Подробный статус сервера** с информацией о текущей работе и задачах.

**Ответ:**
```json
{
  "server": {
    "status": "running",
    "running": true,
    "port": 3456,
    "project_dir": "D:\\Space\\life",
    "cursor_cli_available": true,
    "auto_todo_enabled": true
  },
  "server_state": {
    "clean_shutdown": true,
    "last_start_time": "2026-01-19T09:00:00",
    "last_stop_time": "2026-01-19T08:00:00",
    "session_id": "20260119_090000",
    "iteration_count": 5,
    "current_activity": "Выполнение задачи: Реализация Learning..."
  },
  "tasks": {
    "in_progress": 1,
    "completed": 5,
    "failed": 2,
    "pending": 3,
    "total": 11,
    "pending_in_todo": 3
  },
  "current_task": {
    "task_id": "task_1234567890",
    "task_text": "Реализация Learning (Этап 14)...",
    "state": "in_progress",
    "start_time": "2026-01-19T09:15:00",
    "attempts": 1
  }
}
```

**Поля:**
- `server.status` - статус сервера ("running" или "stopped")
- `server_state.current_activity` - что делает сервер сейчас
- `tasks.in_progress` - задачи в работе
- `tasks.completed` - выполнено задач
- `tasks.failed` - пропущено/ошибок задач
- `tasks.pending` - ожидающих выполнения
- `tasks.total` - всего задач в checkpoint
- `tasks.pending_in_todo` - задач в TODO списке
- `current_task` - информация о текущей задаче (если есть)

### 4. POST /stop
Остановить сервер немедленно. Текущая задача будет прервана, checkpoint будет сохранен.

**Ответ:**
```json
{
  "status": "stopping",
  "message": "Сервер будет остановлен немедленно",
  "timestamp": "2026-01-19T09:00:00"
}
```

**Поведение:**
- Сервер останавливается немедленно при получении запроса
- Текущая выполняемая задача прерывается
- Checkpoint сохраняется перед остановкой
- Все активные операции (ожидание файлов, выполнение инструкций) прерываются

### 5. POST /restart
Перезапустить сервер после завершения текущей итерации.

**Ответ:**
```json
{
  "status": "restarting",
  "message": "Сервер будет перезапущен после завершения текущей итерации",
  "timestamp": "2026-01-19T09:00:00"
}
```

## Примеры использования

### cURL

```bash
# Проверка здоровья
curl http://127.0.0.1:3456/health

# Получить статус
curl http://127.0.0.1:3456/status

# Остановить сервер
curl -X POST http://127.0.0.1:3456/stop

# Перезапустить сервер
curl -X POST http://127.0.0.1:3456/restart
```

### Python

```python
import requests

BASE_URL = "http://127.0.0.1:3456"

# Проверка здоровья
response = requests.get(f"{BASE_URL}/health")
print(response.json())

# Получить статус
response = requests.get(f"{BASE_URL}/status")
status = response.json()
print(f"Статус: {status['server']['status']}")
print(f"Задач в работе: {status['tasks']['in_progress']}")
print(f"Выполнено: {status['tasks']['completed']}")
print(f"Пропущено: {status['tasks']['failed']}")

# Остановить сервер
response = requests.post(f"{BASE_URL}/stop")
print(response.json())
```

## Детальное описание полей /status

### server
- `status` - текущий статус сервера: `"running"` или `"stopped"`
- `running` - булево значение, работает ли сервер
- `port` - порт HTTP сервера
- `project_dir` - путь к директории проекта
- `cursor_cli_available` - доступен ли Cursor CLI
- `auto_todo_enabled` - включена ли автоматическая генерация TODO

### server_state
- `clean_shutdown` - был ли предыдущий останов корректным
- `last_start_time` - время последнего запуска (ISO format)
- `last_stop_time` - время последнего останова (ISO format)
- `session_id` - идентификатор текущей сессии
- `iteration_count` - количество выполненных итераций
- `current_activity` - описание текущей активности сервера

### tasks
- `in_progress` - количество задач в процессе выполнения
- `completed` - количество успешно выполненных задач
- `failed` - количество задач, завершившихся с ошибкой (пропущено)
- `pending` - количество задач, ожидающих выполнения
- `total` - общее количество задач в checkpoint
- `pending_in_todo` - количество задач в TODO списке

### current_task
Информация о текущей выполняемой задаче (если есть):
- `task_id` - уникальный идентификатор задачи
- `task_text` - текст задачи (первые 200 символов)
- `state` - состояние задачи: `"in_progress"`, `"pending"`, `"completed"`, `"failed"`
- `start_time` - время начала выполнения (ISO format)
- `attempts` - количество попыток выполнения

## Особенности работы

### Остановка
Endpoint `/stop` выполняет **немедленную остановку** сервера:
- Запрос принимается немедленно (статус 200)
- Сервер прерывает текущую задачу и останавливается
- Checkpoint сохраняется перед остановкой
- Все активные операции (ожидание файлов, выполнение инструкций) прерываются
- Это позволяет быстро остановить сервер при необходимости

### Перезапуск
Endpoint `/restart` выполняет перезапуск **после завершения текущей итерации**:
- Запрос принимается немедленно (статус 200)
- Сервер продолжает выполнять текущую задачу
- Перезапуск произойдет после завершения текущей итерации
- Это безопасный способ перезапуска, гарантирующий сохранение checkpoint

### Обработка ошибок Cursor
Сервер автоматически обрабатывает повторяющиеся ошибки Cursor:
- При 3 повторениях одной и той же ошибки выполняется перезапуск Docker контейнера
- Если перезапуск не помогает, сервер автоматически останавливается
- Все ошибки логируются с правильной кодировкой UTF-8

### Кодировка
- Все ответы в формате JSON с кодировкой UTF-8
- Сообщения об ошибках корректно отображаются на русском языке
- Поддержка Windows консоли с правильной кодировкой

## Конфигурация

Настройки HTTP сервера в `config/config.yaml`:

```yaml
server:
  http_enabled: true  # Включить HTTP сервер
  http_port: 3456     # Порт для HTTP сервера
```

## Примечания

1. **Запуск сервера:** `python main.py`
2. **HTTP сервер** запускается автоматически на порту, указанном в конфигурации (по умолчанию 3456)
3. **Endpoint `/stop`** выполняет немедленную остановку, прерывая текущую задачу
4. **Endpoint `/restart`** выполняет перезапуск после завершения текущей итерации
5. **Все ответы** в формате JSON с кодировкой UTF-8
6. **Проверка доступности:** используйте `/health` для мониторинга работоспособности
7. **Детальная информация:** используйте `/status` для получения полной информации о состоянии сервера

## Мониторинг

Рекомендуется периодически проверять статус сервера:

```bash
# Простая проверка здоровья
curl http://127.0.0.1:3456/health

# Детальная информация
curl http://127.0.0.1:3456/status | jq '.tasks'

# Мониторинг в реальном времени (Linux/Mac)
watch -n 5 'curl -s http://127.0.0.1:3456/status | jq ".tasks"'
```

## Устранение неполадок

### Сервер не отвечает
1. Проверьте, что сервер запущен: `python main.py`
2. Проверьте порт в конфигурации: `config/config.yaml`
3. Проверьте логи: `logs/code_agent.log`

### Ошибка подключения
- Убедитесь, что порт 3456 не занят другим процессом
- Проверьте firewall настройки
- Убедитесь, что сервер запущен на `127.0.0.1` (localhost)

### Кодировка в ответах
- Все ответы используют UTF-8
- Если видите кракозябры, проверьте настройки терминала/консоли
